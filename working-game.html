<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç∑„É£„ÉÅ„Éù„Ç±Ôºí</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#764ba2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="„Ç∑„É£„ÉÅ„Éù„Ç±Ôºí">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Á§æÁïú„Ç≠„É£„É©„ÇØ„Çø„ÉºËÇ≤Êàê„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Ç≤„Éº„É†„Äå„Ç∑„É£„ÉÅ„Éù„Ç±Ôºí„Äç„ÄÇ16Á®ÆÈ°û„ÅÆ„É¶„Éã„Éº„ÇØ„Å™„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíËÇ≤Êàê„Åó„ÄÅ„Ç§„Éô„É≥„Éà„ÇíÂÆå‰∫Ü„Åó„Å¶„ÄÅ„Ç¢„Ç§„ÉÜ„É†„ÇíË≥ºÂÖ•„Åó„Å¶„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíËÇ≤„Å¶„Çà„ÅÜÔºÅ">
    <meta name="keywords" content="„Ç≤„Éº„É†,ËÇ≤Êàê„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥,„Ç≠„É£„É©„ÇØ„Çø„ÉºËÇ≤Êàê,„É¢„Éê„Ç§„É´„Ç≤„Éº„É†,ÁÑ°Êñô„Ç≤„Éº„É†,Á§æÁïú">
    <meta name="author" content="„Ç∑„É£„ÉÅ„Éù„Ç±Ôºí">
    
    <!-- Open Graph (Facebook, TwitterÁ≠â„Åß‰ΩøÁî®) -->
    <meta property="og:title" content="„Ç∑„É£„ÉÅ„Éù„Ç±Ôºí - Á§æÁïú„Ç≠„É£„É©„ÇØ„Çø„ÉºËÇ≤Êàê„Ç≤„Éº„É†">
    <meta property="og:description" content="16Á®ÆÈ°û„ÅÆ„É¶„Éã„Éº„ÇØ„Å™„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíËÇ≤Êàê„Åô„Çã„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Ç≤„Éº„É†„ÄÇGoogleË™çË®º„Åß„Éû„É´„ÉÅ„Éá„Éê„Ç§„ÇπÂØæÂøúÔºÅ">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="„Ç∑„É£„ÉÅ„Éù„Ç±Ôºí">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="„Ç∑„É£„ÉÅ„Éù„Ç±Ôºí - Á§æÁïú„Ç≠„É£„É©„ÇØ„Çø„ÉºËÇ≤Êàê„Ç≤„Éº„É†">
    <meta name="twitter:description" content="16Á®ÆÈ°û„ÅÆ„É¶„Éã„Éº„ÇØ„Å™„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíËÇ≤Êàê„Åô„Çã„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Ç≤„Éº„É†">
    
    <!-- Google Analytics (‰ªÆÂ∞éÂÖ• - ÂÆüÈöõ„ÅÆUA„ÅØÂæå„ÅßË®≠ÂÆö) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX', { 'anonymize_ip': true });
    </script>
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        #game-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: #f8f9fa;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            padding-bottom: 90px; /* ‰∏ãÈÉ®„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„ÅÆÈ´ò„ÅïÂàÜ„ÅÆ‰ΩôÁôΩ */
            overflow-y: auto;
            transition: all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
            opacity: 1;
            transform: translateY(0);
        }

        .screen.hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }
        
        .screen.showing {
            animation: slideInFromRight 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOutToLeft {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-30px);
            }
        }

        #loading-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .loading-content {
            text-align: center;
        }

        .loading-content h1 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes wiggle {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-3px) rotate(-2deg); }
            50% { transform: translateX(0) rotate(0deg); }
            75% { transform: translateX(3px) rotate(2deg); }
        }

        .screen-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        .screen-header h1 {
            font-size: 1.8rem;
            color: #495057;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: #5a6268;
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 2rem;
        }

        .character-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .character-card.selected {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .character-card .character-icon {
            width: 80px;
            height: 80px;
            background: #f8f9fa;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            border: 2px solid #dee2e6;
            animation: wiggle 2s ease-in-out infinite;
        }

        .character-card .character-name {
            font-size: 0.8rem;
            font-weight: 700;
            color: #495057;
            margin-bottom: 5px;
        }

        .character-card .character-level {
            font-size: 0.7rem;
            color: #6c757d;
        }

        .character-preview {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .preview-image {
            width: 100px;
            height: 100px;
            background: #f8f9fa;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            border: 3px solid #dee2e6;
        }

        .preview-info h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #495057;
        }

        .preview-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .stat-icon {
            font-size: 1.2rem;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 15px 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .game-header h1 {
            font-size: 1.5rem;
            color: #495057;
        }

        .currency-display {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
            font-weight: 700;
            color: #28a745;
        }

        .currency-icon {
            font-size: 1.5rem;
        }

        .character-display {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .character-image {
            width: 120px;
            height: 120px;
            background: #f8f9fa;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            border: 4px solid #dee2e6;
            position: relative;
        }

        .character-sway {
            animation: sway 3s ease-in-out infinite;
        }

        @keyframes sway {
            0%, 100% { transform: translateX(0px); }
            50% { transform: translateX(5px); }
        }

        .character-info h2 {
            font-size: 1.5rem;
            color: #495057;
            margin-bottom: 10px;
        }

        .level-info {
            background: #e9ecef;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .stats-display {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .stat-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .stat-item:last-child {
            margin-bottom: 0;
        }

        .stat-icon {
            font-size: 1.5rem;
            width: 30px;
            text-align: center;
        }

        .stat-label {
            font-weight: 700;
            color: #495057;
            min-width: 80px;
        }

        .stat-bar {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .stat-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 10px;
            transition: width 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            animation: pulse 2s ease-in-out infinite;
        }
        
        .stat-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
            50% { box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .stat-value {
            font-weight: 700;
            color: #495057;
            min-width: 30px;
            text-align: right;
        }

        .main-navigation {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            position: fixed !important;
            bottom: 0 !important;
            left: 50% !important;
            transform: translateX(-50%);
            width: 100% !important;
            max-width: 480px;
            padding: 15px 10px;
            background: white !important;
            border-top: 2px solid #e9ecef;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            z-index: 9999 !important;
            margin: 0 !important;
            box-sizing: border-box;
        }

        .nav-btn {
            background: white;
            border: none;
            border-radius: 12px;
            padding: 12px 5px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            position: relative;
        }

        .nav-btn:hover:not(.active) {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
            transform: translateY(-2px);
        }
        
        .nav-btn.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
            border-radius: 12px 12px 0 0;
        }

        .nav-icon {
            font-size: 1.2rem;
        }

        .nav-btn span:last-child {
            font-weight: 700;
            color: #495057;
            font-size: 0.7rem;
        }

        .nav-btn.active span:last-child {
            color: white;
        }

        /* „Ç§„Éô„É≥„ÉàÁîªÈù¢„Çπ„Çø„Ç§„É´ */
        .event-selection {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .event-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .event-type-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .event-type-card:hover {
            border-color: #007bff;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .event-type-card.completed {
            background: #e9ecef;
            border-color: #adb5bd;
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .event-type-card.completed:hover {
            transform: none;
            box-shadow: none;
        }

        .event-type-card.completed h4,
        .event-type-card.completed p {
            color: #999;
        }

        .completed-badge {
            background: #6c757d;
            color: white;
            padding: 5px 15px;
            border-radius: 10px;
            font-size: 0.85rem;
            margin-top: 10px;
            display: inline-block;
        }

        .event-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .event-type-card h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .event-type-card p {
            color: #666;
            font-size: 0.9rem;
        }

        .event-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .event-choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .event-choice-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .event-choice-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .event-complete {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .event-rewards {
            margin: 15px 0;
        }

        .reward-positive {
            color: #28a745;
            font-weight: bold;
        }

        .reward-negative {
            color: #dc3545;
            font-weight: bold;
        }

        /* „Ç∑„Éß„ÉÉ„ÉóÁîªÈù¢„Çπ„Çø„Ç§„É´ */
        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
        }

        .shop-item-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .item-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .item-cost {
            color: #007bff;
            font-weight: bold;
            margin-bottom: 15px;
        }

        /* Á∑®ÊàêÁîªÈù¢„Çπ„Çø„Ç§„É´ */
        .party-formation, .owned-characters, .purchasable-characters {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .party-slots {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .party-slot {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .slot-content {
            width: 100%;
        }

        .slot-content img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-bottom: 5px;
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .character-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .character-card:hover {
            border-color: #007bff;
            transform: translateY(-2px);
        }

        .character-card img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .character-cost {
            color: #007bff;
            font-weight: bold;
            margin: 5px 0;
        }

        /* „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„ÉàÈÄöÁü•„Çπ„Çø„Ç§„É´ */
        .achievement-notification {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s ease;
        }
        
        .achievement-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            color: white;
        }
        
        .achievement-content .achievement-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: bounce 0.6s ease;
        }
        
        .achievement-content h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #ffd700;
        }
        
        .achievement-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .achievement-description {
            font-size: 1rem;
            margin: 10px 0;
            opacity: 0.9;
        }
        
        .achievement-progress {
            font-size: 0.9rem;
            margin: 15px 0;
            opacity: 0.8;
        }
        
        /* „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà‰∏ÄË¶ß„Çπ„Çø„Ç§„É´ */
        .achievement-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .achievement-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .achievement-item.completed {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: #4caf50;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .achievement-item.completed .achievement-item-name {
            color: #2e7d32;
        }
        
        .achievement-item.completed .achievement-item-description {
            color: #1b5e20;
        }
        
        .achievement-item-icon {
            font-size: 2.5rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .achievement-item-info {
            flex-grow: 1;
        }
        
        .achievement-item-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .achievement-item-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }
        
        .achievement-progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .achievement-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.3s ease;
        }
        
        .achievement-progress-text {
            font-size: 0.85rem;
            color: #666;
        }
        
        .achievement-checkmark {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: #4caf50;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        /* Ë®≠ÂÆöÁîªÈù¢„Çπ„Çø„Ç§„É´ */
        .settings-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .save-load-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .game-stats p {
            margin: 10px 0;
            font-size: 1.1rem;
        }

        .game-stats span {
            font-weight: bold;
            color: #007bff;
        }

        /* ÂãïÁîª„ÇÆ„É£„É©„É™„Éº„Çπ„Çø„Ç§„É´ */
        .video-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .video-item h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .video-item video {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .video-item p {
            color: #666;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        /* „Éà„Éº„Çπ„ÉàÈÄöÁü• */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.error {
            background: #dc3545;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            width: 100%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 123, 255, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4);
        }
        
        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-primary:active:not(:disabled)::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.error {
            background: #dc3545;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Ë≥ºÂÖ•ÊàêÂäü„ÉÄ„Ç§„Ç¢„É≠„Ç∞ */
        .purchase-success-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .purchase-success-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: scaleIn 0.3s ease;
        }

        .purchase-success-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: bounce 0.5s ease;
        }

        .purchase-success-content h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .stat-changes {
            margin: 30px 0;
        }

        .stat-change-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            background: #f8f9fa;
            animation: slideUp 0.3s ease;
        }

        .stat-change-item.positive {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .stat-change-item.negative {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .stat-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .stat-name {
            flex: 1;
            text-align: left;
            color: #333;
            font-weight: 500;
        }

        .stat-change {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .stat-change-item.positive .stat-change {
            color: #28a745;
        }

        .stat-change-item.negative .stat-change {
            color: #dc3545;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* „Ç≠„É£„É©„ÇØ„Çø„ÉºË©≥Á¥∞„ÉÄ„Ç§„Ç¢„É≠„Ç∞ */
        .character-details-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
        }

        .character-details-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: scaleIn 0.3s ease;
        }

        .character-details-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            gap: 20px;
        }

        .character-details-icon img,
        .character-details-icon div {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: contain;
        }

        .character-details-info h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .character-description {
            color: #666;
            font-size: 0.95rem;
        }

        .character-details-stats {
            margin: 30px 0;
        }

        .character-details-stats h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stat-item .stat-icon {
            font-size: 1.5rem;
        }

        .stat-item .stat-label {
            flex: 1;
            color: #333;
            font-weight: 500;
        }

        .stat-item .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #007bff;
        }

        .character-details-purchases {
            margin: 30px 0;
        }

        .character-details-purchases h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .purchase-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .purchase-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .purchase-icon {
            font-size: 1.5rem;
        }

        .purchase-name {
            flex: 1;
            color: #333;
            font-weight: 500;
        }

        .purchase-date {
            color: #666;
            font-size: 0.9rem;
        }

        .character-card-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-detail,
        .btn-add {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-detail {
            background: #6c757d;
            color: white;
        }

        .btn-detail:hover {
            background: #5a6268;
        }

        .btn-add {
            background: #28a745;
            color: white;
        }

        .btn-add:hover {
            background: #218838;
        }

        /* „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÊºîÂá∫„ÉÄ„Ç§„Ç¢„É≠„Ç∞ */
        .level-up-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            animation: fadeIn 0.5s ease;
        }

        .level-up-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 50px 40px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
            animation: scaleIn 0.5s ease;
            max-width: 400px;
            width: 90%;
        }

        .level-up-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 1s ease infinite;
        }

        .level-up-content h2 {
            color: white;
            font-size: 2rem;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .level-up-animation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }

        .old-level,
        .new-level {
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .old-level {
            animation: fadeOut 0.5s ease;
        }

        .new-level {
            animation: fadeIn 0.5s ease;
            font-size: 3rem;
            color: #ffd700;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
        }

        .arrow {
            font-size: 3rem;
            color: white;
        }

        .level-up-message {
            color: white;
            font-size: 1.2rem;
            margin: 20px 0;
        }

        /* „Çø„Éñ„É¨„ÉÉ„ÉàÂØæÂøú (481px - 1024px) */
        @media (min-width: 481px) and (max-width: 1024px) {
            #game-container {
                max-width: 600px;
            }
            
            .screen {
                padding: 25px;
                padding-bottom: 100px;
            }
            
            .character-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 20px;
            }
            
            .screen-header h1 {
                font-size: 2rem;
            }
            
            .character-card .character-icon {
                width: 100px;
                height: 100px;
                font-size: 3rem;
            }
            
            .btn-primary {
                padding: 15px 30px;
                font-size: 1.1rem;
            }
        }
        
        /* Â§ßÁîªÈù¢ÂØæÂøú (1025px+) */
        @media (min-width: 1025px) {
            #game-container {
                max-width: 800px;
            }
            
            .screen {
                padding: 30px;
                padding-bottom: 110px;
            }
            
            .character-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 25px;
            }
            
            .screen-header h1 {
                font-size: 2.5rem;
            }
            
            .character-card .character-icon {
                width: 120px;
                height: 120px;
                font-size: 3.5rem;
            }
            
            .main-navigation {
                padding: 20px 15px;
                gap: 15px;
            }
            
            .nav-icon {
                font-size: 1.5rem;
            }
            
            .nav-btn span {
                font-size: 1rem;
            }
            
            .btn-primary {
                padding: 18px 40px;
                font-size: 1.2rem;
            }
        }
        
        /* „É¢„Éê„Ç§„É´ÂØæÂøú (480px‰ª•‰∏ã) */
        @media (max-width: 480px) {
            .screen {
                padding: 15px;
                padding-bottom: 90px;
            }
            
            .character-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
            
            .main-navigation {
                padding: 10px 5px;
            }
        }
        
        /* Ê®™Âêë„ÅçÂØæÂøú */
        @media (orientation: landscape) and (max-height: 600px) {
            .screen {
                padding: 10px;
                padding-bottom: 70px;
            }
            
            .screen-header {
                margin-bottom: 1rem;
            }
            
            .screen-header h1 {
                font-size: 1.5rem;
            }
            
            .character-card .character-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
            
            .main-navigation {
                padding: 8px 5px;
            }
            
            .nav-icon {
                font-size: 1rem;
            }
            
            .nav-btn span {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Loading Screen -->
        <div id="loading-screen" class="screen">
            <div class="loading-content">
                <h1>„Ç∑„É£„ÉÅ„Éù„Ç±Ôºí</h1>
                <div class="loading-spinner"></div>
                <p>Ë™≠„ÅøËæº„Åø‰∏≠...</p>
            </div>
        </div>

        <!-- Login Required Screen -->
        <div id="login-required" class="screen">
            <div class="screen-header">
                <h1>„Ç∑„É£„ÉÅ„Éù„Ç±Ôºí</h1>
                <p>„Ç≤„Éº„É†„ÇíÈñãÂßã„Åô„Çã„Å´„ÅØGoogleË™çË®º„ÅåÂøÖË¶Å„Åß„Åô</p>
            </div>
            <div style="text-align: center; padding: 40px 20px;">
                <div style="background: #f8f9fa; padding: 30px; border-radius: 10px; margin: 20px 0;">
                    <h2 style="color: #333; margin-bottom: 20px;">üîê Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô</h2>
                    <p style="color: #666; margin-bottom: 30px;">
                        „Ç≤„Éº„É†„Éá„Éº„Çø„ÇíÂÆâÂÖ®„Å´‰øùÂ≠ò„Åó„ÄÅË§áÊï∞„ÅÆ„Éá„Éê„Ç§„Çπ„ÅßÂêåÊúü„Åô„Çã„Åü„ÇÅ„Å´<br>
                        Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„ÅÆ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô
                    </p>
                    <button onclick="signInWithGoogle()" 
                            aria-label="Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥"
                            style="padding: 15px 30px; background: #4285f4; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold;">
                        Google„Åß„É≠„Ç∞„Ç§„É≥
                    </button>
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;">
                        <p style="color: #856404; margin: 0; font-size: 14px;">
                            ‚ö†Ô∏è ÁèæÂú®„ÅØ„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„ÅßÂãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ<br>
                            Ë™çË®ºÊ©üËÉΩ„ÅØ‰∏ÄÊôÇÁöÑ„Å´ÁÑ°ÂäπÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ
                        </p>
                    </div>
                </div>
                <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <p style="color: #856404; margin: 0; font-size: 14px;">
                        üí° „É≠„Ç∞„Ç§„É≥Âæå„ÅØ„ÄÅ„Ç≤„Éº„É†„Éá„Éº„Çø„ÅåËá™ÂãïÁöÑ„Å´„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åï„Çå„ÄÅ<br>
                        ‰ªñ„ÅÆ„Éá„Éê„Ç§„Çπ„Åã„Çâ„ÇÇÂêå„Åò„Éá„Éº„Çø„Åß„Ç≤„Éº„É†„ÇíÁ∂ö„Åë„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô
                    </p>
                </div>
            </div>
        </div>

        <!-- Character Selection Screen -->
        <div id="character-selection" class="screen hidden">
            <div class="screen-header">
                <h1>„Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû</h1>
                <p>ÊúÄÂàù„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</p>
                <!-- Ë™çË®ºÁä∂ÊÖãË°®Á§∫ -->
                <div id="auth-status" style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                    <div id="auth-info" style="display: none;">
                        <span id="user-email" style="font-weight: bold; color: #2e7d32;"></span>
                        <button onclick="signOut()" style="margin-left: 10px; padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                    </div>
                    <div id="login-prompt" style="display: none;">
                        <p style="margin-bottom: 10px;">„Ç≤„Éº„É†„Éá„Éº„Çø„Çí„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åô„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                        <button onclick="signInWithGoogle()" style="padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Google„Åß„É≠„Ç∞„Ç§„É≥</button>
                    </div>
                </div>
            </div>
            <div class="character-grid" id="character-grid">
                <!-- Characters will be populated by JavaScript -->
            </div>
            <div class="character-preview" id="character-preview">
                <div class="preview-image"></div>
                <div class="preview-info">
                    <h3 id="preview-name">„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç</h3>
                    <div class="preview-stats">
                        <div class="stat-item">
                            <span class="stat-icon">üò§</span>
                            <span>ËÄê„Çπ„Éà„É¨„Çπ: <span id="preview-stress">0</span></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-icon">üß†</span>
                            <span>Áü•Ë≠ò: <span id="preview-knowledge">0</span></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-icon">üí™</span>
                            <span>‰ΩìÂäõ: <span id="preview-physical">0</span></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-icon">üí¨</span>
                            <span>„Ç≥„Éü„É•Âäõ: <span id="preview-communication">0</span></span>
                        </div>
                    </div>
                </div>
            </div>
            <button id="confirm-character" class="btn-primary" disabled>ÈÅ∏ÊäûÁ¢∫ÂÆö</button>
        </div>

        <!-- Main Game Screen -->
        <div id="main" class="screen hidden">
            <!-- Header -->
            <div class="game-header">
                <h1>„Ç∑„É£„ÉÅ„Éù„Ç±Ôºí</h1>
                <div class="currency-display">
                    <span id="currency-amount">0</span>„Ç∑„É£„ÉÅ
                </div>
                <!-- Ë™çË®ºÁä∂ÊÖãË°®Á§∫Ôºà„É°„Ç§„É≥ÁîªÈù¢Ôºâ -->
                <div id="main-auth-status" style="position: absolute; top: 10px; right: 10px; font-size: 12px;">
                    <div id="main-auth-info" style="display: none;">
                        <span id="main-user-email" style="color: #2e7d32;"></span>
                        <button onclick="signOut()" style="margin-left: 5px; padding: 2px 8px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                    </div>
                    <div id="main-login-prompt" style="display: none;">
                        <button onclick="signInWithGoogle()" style="padding: 5px 10px; background: #4285f4; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;">„É≠„Ç∞„Ç§„É≥</button>
                    </div>
                </div>
            </div>

            <!-- Character Display -->
            <div class="character-display">
                <div class="character-image" id="main-character-image">
                    <div class="character-sway"></div>
                </div>
                <div class="character-info">
                    <h2 id="character-name">„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç</h2>
                    <div class="level-info">
                        <span>„É¨„Éô„É´ <span id="character-level">1</span></span>
                    </div>
                </div>
            </div>

            <!-- Stats Display -->
            <div class="stats-display">
                <div class="stat-item">
                    <span class="stat-icon">üò§</span>
                    <span class="stat-label">ËÄê„Çπ„Éà„É¨„Çπ</span>
                    <div class="stat-bar">
                        <div class="stat-fill" id="stress-bar"></div>
                    </div>
                    <span class="stat-value" id="stress-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">üß†</span>
                    <span class="stat-label">Áü•Ë≠ò</span>
                    <div class="stat-bar">
                        <div class="stat-fill" id="knowledge-bar"></div>
                    </div>
                    <span class="stat-value" id="knowledge-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">üí™</span>
                    <span class="stat-label">‰ΩìÂäõ</span>
                    <div class="stat-bar">
                        <div class="stat-fill" id="physical-bar"></div>
                    </div>
                    <span class="stat-value" id="physical-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">üí¨</span>
                    <span class="stat-label">„Ç≥„Éü„É•Âäõ</span>
                    <div class="stat-bar">
                        <div class="stat-fill" id="communication-bar"></div>
                    </div>
                    <span class="stat-value" id="communication-value">0</span>
                </div>
            </div>
        </div>

        <!-- Events Screen -->
        <div id="events" class="screen hidden">
            <div class="screen-header">
                <h1>„Ç§„Éô„É≥„Éà</h1>
                <div class="event-info">
                    <span>‰ªäÊó•„ÅÆ„Ç§„Éô„É≥„Éà: <span id="events-remaining">3</span>/3</span>
                </div>
            </div>
            <div class="events-content" id="events-content">
                <!-- „Ç§„Éô„É≥„ÉàÈÅ∏ÊäûÁîªÈù¢ -->
                <div class="event-selection" id="event-selection">
                    <h3>‰ªäÊó•„ÅÆ„Ç§„Éô„É≥„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
                    <div class="event-types" id="event-types">
                        <!-- „Ç§„Éô„É≥„Éà„Ç´„Éº„Éâ„ÅØ JavaScript „ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
                    </div>
                </div>
                
                <!-- „Ç§„Éô„É≥„ÉàË©≥Á¥∞ÁîªÈù¢ -->
                <div class="event-card" id="current-event" style="display: none;">
                    <h3 id="event-title"></h3>
                    <p id="event-description"></p>
                    <div class="event-choices" id="event-choices"></div>
                </div>
                <div class="event-complete" id="event-complete" style="display: none;">
                    <h3>„Ç§„Éô„É≥„ÉàÂÆå‰∫ÜÔºÅ</h3>
                    <p id="event-feedback"></p>
                    <div class="event-rewards" id="event-rewards"></div>
                    <button class="btn-primary" onclick="nextEvent()">Ê¨°„ÅÆ„Ç§„Éô„É≥„Éà</button>
                </div>
                <div class="no-events" id="no-events" style="display: none;">
                    <h3>‰ªäÊó•„ÅÆ„Ç§„Éô„É≥„Éà„ÅØÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü</h3>
                    <p>ÊòéÊó•„Åæ„ÅüÊñ∞„Åó„ÅÑ„Ç§„Éô„É≥„Éà„ÅåÁô∫Áîü„Åó„Åæ„ÅôÔºÅ</p>
                    <button class="btn-primary" onclick="showScreen('main')">„Éõ„Éº„É†„Å´Êàª„Çã</button>
                </div>
            </div>
        </div>

        <!-- Shop Screen -->
        <div id="shop" class="screen hidden">
            <div class="screen-header">
                <h1>„Ç∑„Éß„ÉÉ„Éó</h1>
            </div>
            <div class="shop-content">
                <div class="shop-items" id="shop-items">
                    <!-- „Ç∑„Éß„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
                </div>
            </div>
        </div>

        <!-- Formation Screen -->
        <div id="formation" class="screen hidden">
            <div class="screen-header">
                <h1>Á∑®Êàê</h1>
            </div>
            <div class="formation-content">
                <div class="party-formation">
                    <h3>„Éë„Éº„ÉÜ„Ç£„ÉºÁ∑®Êàê</h3>
                    <div class="party-slots" id="party-slots">
                        <!-- „Éë„Éº„ÉÜ„Ç£„Éº„Çπ„É≠„ÉÉ„Éà„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
                    </div>
                </div>
                
                <div class="owned-characters">
                    <h3>ÊâÄÊúâ„Ç≠„É£„É©„ÇØ„Çø„Éº</h3>
                    <div class="character-grid" id="owned-characters">
                        <!-- ÊâÄÊúâ„Ç≠„É£„É©„ÇØ„Çø„Éº„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
                    </div>
                </div>
                
                <div class="purchasable-characters">
                    <h3>Ë≥ºÂÖ•ÂèØËÉΩ„Ç≠„É£„É©„ÇØ„Çø„Éº</h3>
                    <div class="character-grid" id="purchasable-characters">
                        <!-- Ë≥ºÂÖ•ÂèØËÉΩ„Ç≠„É£„É©„ÇØ„Çø„Éº„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settings" class="screen hidden">
            <div class="screen-header">
                <h1>Ë®≠ÂÆö</h1>
            </div>
            <div class="settings-content">
                <div class="settings-section">
                    <h3>„Çª„Éº„Éñ„Éª„É≠„Éº„Éâ</h3>
                    <div class="save-load-buttons">
                        <button class="btn-primary" onclick="saveGame()">„Ç≤„Éº„É†„Çí„Çª„Éº„Éñ</button>
                        <button class="btn-secondary" onclick="loadGame()">„Ç≤„Éº„É†„Çí„É≠„Éº„Éâ</button>
                        <button class="btn-danger" onclick="resetGame()">„Ç≤„Éº„É†„Çí„É™„Çª„ÉÉ„Éà</button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>„Ç≤„Éº„É†Áµ±Ë®à</h3>
                    <div class="game-stats" id="game-stats">
                        <p>„Éó„É¨„Ç§Êó•Êï∞: <span id="total-days">0</span>Êó•</p>
                        <p>Áç≤Âæó„Ç∑„É£„ÉÅ: <span id="total-shachi">0</span>„Ç∑„É£„ÉÅ</p>
                        <p>ÂÆå‰∫Ü„Ç§„Éô„É≥„Éà: <span id="total-events">0</span>ÂÄã</p>
                        <p>ÊâÄÊúâ„Ç≠„É£„É©„ÇØ„Çø„Éº: <span id="owned-count">0</span>‰Ωì</p>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>„Çª„Ç≠„É•„É™„ÉÜ„Ç£Áõ£Êüª</h3>
                    <div class="save-load-buttons">
                        <button class="btn btn-secondary" onclick="performSecurityAudit()">
                            üîç „Çª„Ç≠„É•„É™„ÉÜ„Ç£Áõ£ÊüªÂÆüË°å
                        </button>
                        <button class="btn btn-secondary" onclick="checkAndFixRLS()">
                            üõ°Ô∏è RLSË®≠ÂÆöÁ¢∫Ë™ç
                        </button>
                    </div>
                    <p class="settings-description">
                        „Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆ„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„ÄÅÂïèÈ°å„Åå„ÅÇ„Çå„Å∞‰øÆÊ≠£ÊâãÈ†Ü„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ
                    </p>
                </div>
                
                <div class="settings-section">
                    <h3>„Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà</h3>
                    <div class="achievement-list" id="achievement-list">
                        <!-- „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà‰∏ÄË¶ß„ÅØÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
                    </div>
                    <button class="btn-secondary" onclick="renderAchievements()" style="margin-top: 15px;">„Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà„ÇíÊõ¥Êñ∞</button>
                </div>
                
                <div class="settings-section">
                    <h3>ÂãïÁîª„ÇÆ„É£„É©„É™„Éº</h3>
                    <div class="video-gallery" id="video-gallery">
                        <div class="video-item">
                            <h4>„Ç§„É≥„Éà„É≠ÂãïÁîª</h4>
                            <video controls width="100%" style="max-width: 300px;">
                                <source src="20_movie/intro01.mp4" type="video/mp4">
                                „Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÂãïÁîª„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ
                            </video>
                            <p>„Ç≤„Éº„É†„ÅÆ„Ç§„É≥„Éà„É≠„ÉÄ„ÇØ„Ç∑„Éß„É≥ÂãïÁîª</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // SupabaseË®≠ÂÆö
        const SUPABASE_URL = 'https://uvrzanksalwjnxoreijl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2cnphbmtzYWx3am54b3JlaWpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0Mjg2MzcsImV4cCI6MjA3NzAwNDYzN30.ShwFpsm64P8IwWlLFM4BcbbWf9Ar8tLXUev3ZgAjQDM';
        
        // Supabase„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂàùÊúüÂåñ
        let supabase = null;
        let useLocalMode = false;
        
        // „É¢„Éê„Ç§„É´Á´ØÊú´„ÇíÊ§úÂá∫
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        console.log('„Éá„Éê„Ç§„ÇπÊ§úÂá∫:', isMobile ? '„Çπ„Éû„Éõ' : 'PC');
        console.log('User Agent:', navigator.userAgent);
        
        try {
            // „Åô„Åπ„Å¶„ÅÆ„Éá„Éê„Ç§„Çπ„ÅßSupabaseÊé•Á∂ö„ÇíË©¶Ë°å
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂàùÊúüÂåñÊàêÂäü');
            useLocalMode = false;
        } catch (error) {
            console.error('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            supabase = null;
            useLocalMode = true;
            console.log('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„ÅßÂãï‰Ωú„Åó„Åæ„Åô');
        }
        
        // Êé•Á∂ö„ÉÜ„Çπ„Éà
        if (supabase) {
            supabase.auth.getSession().then(({ data, error }) => {
                if (error) {
                    console.error('SupabaseÊé•Á∂ö„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', error);
                } else {
                    console.log('SupabaseÊé•Á∂ö„ÉÜ„Çπ„ÉàÊàêÂäü:', data.session ? '„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÇ„Çä' : '„Çª„ÉÉ„Ç∑„Éß„É≥„Å™„Åó');
                }
            });
        }
        
        // Ë™çË®ºÁä∂ÊÖãÁÆ°ÁêÜ
        let currentUser = null;
        let isAuthenticated = false;
        
        // „Ç§„Éô„É≥„ÉàÈÅ∏ÊäûÁä∂ÊÖãÁÆ°ÁêÜ
        let selectedEventType = null;
        let currentSelectedEventId = null;
        
        // „Ç≠„É£„ÉÉ„Ç∑„É•ÁÆ°ÁêÜ
        const dataCache = {
            profiles: null,
            gameSaves: null,
            eventHistory: null,
            purchaseHistory: null,
            lastFetch: {},
            TTL: 60000 // 1ÂàÜÈñì„Ç≠„É£„ÉÉ„Ç∑„É•
        };
        
        function getCachedData(key) {
            const cached = dataCache[key];
            if (!cached) return null;
            
            const now = Date.now();
            const lastFetch = dataCache.lastFetch[key] || 0;
            
            if (now - lastFetch > dataCache.TTL) {
                dataCache[key] = null;
                return null;
            }
            
            return cached;
        }
        
        function setCachedData(key, data) {
            dataCache[key] = data;
            dataCache.lastFetch[key] = Date.now();
        }
        
        function clearCache() {
            dataCache.profiles = null;
            dataCache.gameSaves = null;
            dataCache.eventHistory = null;
            dataCache.purchaseHistory = null;
            dataCache.lastFetch = {};
        }
        
        // „Ç≤„Éº„É†„Éá„Éº„Çø
        const GAME_CONFIG = {
            INITIAL_SHACHI: 200,
            CHARACTER_COST: 500,
            MAX_DAILY_EVENTS: 3,
            STAT_CAP: 100,
            LEVEL_UP_SHACHI: 50
        };

        // „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„ÉàÂÆöÁæ©
        const ACHIEVEMENTS = [
            {
                id: 'level_5',
                name: 'ÂàùÂøÉËÄÖÁ§æÂì°',
                description: '„É¨„Éô„É´5„Å´Âà∞ÈÅî',
                type: 'level',
                target: 5,
                icon: 'üéì'
            },
            {
                id: 'level_10',
                name: '‰∏≠Á¥öÁ§æÂì°',
                description: '„É¨„Éô„É´10„Å´Âà∞ÈÅî',
                type: 'level',
                target: 10,
                icon: 'üìä'
            },
            {
                id: 'level_20',
                name: '‰∏äÁ¥öÁ§æÂì°',
                description: '„É¨„Éô„É´20„Å´Âà∞ÈÅî',
                type: 'level',
                target: 20,
                icon: '‚≠ê'
            },
            {
                id: 'events_10',
                name: '„Ç§„Éô„É≥„ÉàÁéã',
                description: '„Ç§„Éô„É≥„Éà„Çí10ÂõûÂÆå‰∫Ü',
                type: 'events',
                target: 10,
                icon: 'üìÖ'
            },
            {
                id: 'items_5',
                name: 'Ë≤∑„ÅÑÁâ©Â•Ω„Åç',
                description: '„Ç¢„Ç§„ÉÜ„É†„Çí5ÂõûË≥ºÂÖ•',
                type: 'items',
                target: 5,
                icon: 'üõí'
            },
            {
                id: 'shachi_1000',
                name: 'Ë≤ØÈáë‰∏äÊâã',
                description: '„Ç∑„É£„ÉÅ„Çí1000Áç≤Âæó',
                type: 'shachi',
                target: 1000,
                icon: 'üí∞'
            }
        ];

        const SHOP_ITEMS = [
            {
                id: 'stomach_medicine',
                name: 'ËÉÉËñ¨',
                icon: 'üíä',
                cost: 50,
                description: '„Çπ„Éà„É¨„ÇπËÄêÊÄß+10',
                effect: { stress: 10 }
            },
            {
                id: 'trackball_mouse',
                name: '„Éà„É©„ÉÉ„ÇØ„Éú„Éº„É´„Éû„Ç¶„Çπ',
                icon: 'üñ±Ô∏è',
                cost: 80,
                description: '‰ΩìÂäõ+15',
                effect: { physical: 15 }
            },
            {
                id: 'energy_drink',
                name: '„Ç®„Éä„Ç∏„Éº„Éâ„É™„É≥„ÇØ',
                icon: 'ü•§',
                cost: 30,
                description: '‰ΩìÂäõ+5, „Çπ„Éà„É¨„ÇπËÄêÊÄß+5',
                effect: { physical: 5, stress: 5 }
            },
            {
                id: 'sleeping_bag',
                name: 'ÂØùË¢ã',
                icon: 'üõå',
                cost: 100,
                description: '„Çπ„Éà„É¨„ÇπËÄêÊÄß+20',
                effect: { stress: 20 }
            },
            {
                id: 'coffee',
                name: '„Ç≥„Éº„Éí„Éº',
                icon: '‚òï',
                cost: 20,
                description: 'Áü•Ë≠ò+8',
                effect: { knowledge: 8 }
            },
            {
                id: 'vitamin',
                name: '„Éì„Çø„Éü„É≥Ââ§',
                icon: 'üíä',
                cost: 40,
                description: '‰ΩìÂäõ+10, „Ç≥„Éü„É•Âäõ+5',
                effect: { physical: 10, communication: 5 }
            },
            {
                id: 'convenience_bento',
                name: '„Ç≥„É≥„Éì„ÉãÂºÅÂΩì',
                icon: 'üç±',
                cost: 25,
                description: '‰ΩìÂäõ+8',
                effect: { physical: 8 }
            },
            {
                id: 'cup_noodle',
                name: '„Ç´„ÉÉ„Éó„É©„Éº„É°„É≥',
                icon: 'üçú',
                cost: 15,
                description: '‰ΩìÂäõ+3, „Çπ„Éà„É¨„ÇπËÄêÊÄß+3',
                effect: { physical: 3, stress: 3 }
            }
        ];

        const DAILY_EVENTS = [
            {
                id: 'boss_interaction',
                title: '‰∏äÂè∏„ÅåË©±„Åó„Åã„Åë„Å¶„Åç„ÅüÔºÅ',
                description: 'Á™ÅÁÑ∂‰∏äÂè∏„Åå„ÅÇ„Å™„Åü„ÅÆ„Éá„Çπ„ÇØ„Å´„ÇÑ„Å£„Å¶„Åç„Åæ„Åó„Åü„ÄÇ',
                choices: [
                    {
                        text: 'Á¥†Êó©„ÅèÁ´ã„Å°‰∏ä„Åå„Å£„Å¶Êå®Êã∂„Åô„Çã',
                        effect: { shachi: 30, stress: -5, communication: 5 },
                        feedback: '‰∏äÂè∏„Å´Â•ΩÂç∞Ë±°„Çí‰∏é„Åà„Åæ„Åó„ÅüÔºÅ'
                    },
                    {
                        text: '‰ΩúÊ•≠„ÇíÁ∂ö„Åë„Å™„Åå„ÇâËªΩ„ÅèËøî‰∫ã„Åô„Çã',
                        effect: { shachi: 10, stress: 0, knowledge: 2 },
                        feedback: '„Åæ„ÅÇ„Åæ„ÅÇ„ÅÆÂØæÂøú„Åß„Åó„Åü„ÄÇ'
                    },
                    {
                        text: 'Ê∞ó„Å•„Åã„Å™„ÅÑ„Åµ„Çä„Çí„Åó„Å¶ÁÑ°Ë¶ñ„Åô„Çã',
                        effect: { shachi: -20, stress: 10, communication: -10 },
                        feedback: '‰∏äÂè∏„ÅÆÊ©üÂ´å„ÇíÊêç„Å≠„Å¶„Åó„Åæ„ÅÑ„Åæ„Åó„Åü...'
                    }
                ]
            },
            {
                id: 'office_politics',
                title: '„ÅäÂ±ÄÊßò„Åã„Çâ„ÅÆÂ´åÂë≥',
                description: 'ÂÖàËº©Á§æÂì°„Åã„ÇâÂ´åÂë≥„ÇíË®Ä„Çè„Çå„Åæ„Åó„Åü„ÄÇ',
                choices: [
                    {
                        text: 'Á¥†Áõ¥„Å´Ë¨ù„Å£„Å¶ÊîπÂñÑ„ÇíÁ¥ÑÊùü„Åô„Çã',
                        effect: { shachi: 25, stress: -3, communication: 8 },
                        feedback: 'Â§ß‰∫∫„Å™ÂØæÂøú„ÅßË©ï‰æ°„Åï„Çå„Åæ„Åó„ÅüÔºÅ'
                    },
                    {
                        text: 'ÂÜ∑Èùô„Å´Áä∂Ê≥Å„ÇíË™¨Êòé„Åô„Çã',
                        effect: { shachi: 15, stress: 5, knowledge: 5 },
                        feedback: 'Ë´ñÁêÜÁöÑ„Å™ÂØæÂøú„Åß„Åó„Åü„ÄÇ'
                    },
                    {
                        text: 'Ë®Ä„ÅÑËøî„Åó„Å¶ÂØæÁ´ã„Åô„Çã',
                        effect: { shachi: -30, stress: 15, communication: -15 },
                        feedback: 'ËÅ∑Â†¥„ÅÆÈõ∞Âõ≤Ê∞ó„ÅåÊÇ™„Åè„Å™„Çä„Åæ„Åó„Åü...'
                    }
                ]
            },
            {
                id: 'customer_service',
                title: '„Ç´„Çπ„Éè„É©ÂÆ¢„Åã„Çâ„ÅÆÈõªË©±',
                description: 'ÁêÜ‰∏çÂ∞Ω„Å™„ÇØ„É¨„Éº„É†ÈõªË©±„Åå„Åã„Åã„Å£„Å¶„Åç„Åæ„Åó„Åü„ÄÇ',
                choices: [
                    {
                        text: '‰∏ÅÂØß„Å´Ë™¨Êòé„Åó„Å¶Ëß£Ê±∫„ÇíÂõ≥„Çã',
                        effect: { shachi: 40, stress: -8, communication: 10 },
                        feedback: '„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Å™ÂØæÂøú„Åß„Åó„ÅüÔºÅ'
                    },
                    {
                        text: '‰∏äÂè∏„Å´Âºï„ÅçÁ∂ô„Åê',
                        effect: { shachi: 20, stress: -2, knowledge: 3 },
                        feedback: 'ÈÅ©Âàá„Å™Âà§Êñ≠„Åß„Åó„Åü„ÄÇ'
                    },
                    {
                        text: 'ÈõªË©±„ÇíÂàá„Å£„Å¶„Åó„Åæ„ÅÜ',
                        effect: { shachi: -50, stress: 20, communication: -20 },
                        feedback: 'Â§ßÂïèÈ°å„Å´„Å™„Å£„Å¶„Åó„Åæ„ÅÑ„Åæ„Åó„Åü...'
                    }
                ]
            }
        ];

        const CHARACTERS = [
            { id: 'ikisui', name: 'ÁîüÁ≤ã„ÅÆÁ§æÁïú', icon: '001.png', baseStats: { stress: 90, knowledge: 70, physical: 80, communication: 60 } },
            { id: 'genkai', name: 'ÈôêÁïåÁ™ÅÁ†¥Á§æÁïú', icon: '002.png', baseStats: { stress: 95, knowledge: 75, physical: 85, communication: 65 } },
            { id: 'muhai', name: 'ÁÑ°Êïó„ÅÆËÅ∑‰∫∫Á§æÁïú', icon: '003.png', baseStats: { stress: 85, knowledge: 90, physical: 75, communication: 70 } },
            { id: 'kokou', name: 'Â≠§È´ò„ÅÆÊàêÊûú‰∏ªÁæ©Á§æÁïú', icon: '004.png', baseStats: { stress: 80, knowledge: 85, physical: 70, communication: 50 } },
            { id: 'kokoro', name: 'ÂøÉÂÑ™„Åó„ÅçÁ§æÁïú', icon: '005.png', baseStats: { stress: 70, knowledge: 60, physical: 65, communication: 85 } },
            { id: 'seijitsu', name: 'Ë™†ÂÆü„Å™Ë¶≥ÂØüÁ§æÂì°', icon: '006.png', baseStats: { stress: 75, knowledge: 80, physical: 60, communication: 75 } },
            { id: 'kyousou', name: 'ÂÖ±Ââµ„É™„Éº„ÉÄ„ÉºÁ§æÂì°', icon: '007.png', baseStats: { stress: 80, knowledge: 75, physical: 70, communication: 90 } },
            { id: 'mypace', name: '„Éû„Ç§„Éö„Éº„ÇπÁ§æÂì°', icon: '008.png', baseStats: { stress: 60, knowledge: 65, physical: 70, communication: 60 } },
            { id: 'yurufuwa', name: '„ÇÜ„Çã„Åµ„ÇèÁ§æÁïú', icon: '009.png', baseStats: { stress: 50, knowledge: 55, physical: 50, communication: 80 } },
            { id: 'kakure', name: 'Èö†„ÇåÁñ≤Âä¥Á§æÁïú', icon: '010.png', baseStats: { stress: 40, knowledge: 70, physical: 45, communication: 65 } },
            { id: 'ohitoyoshi', name: '„Åä‰∫∫Â•Ω„ÅóÁ§æÂì°', icon: '011.png', baseStats: { stress: 65, knowledge: 60, physical: 60, communication: 85 } },
            { id: 'genjitsu', name: 'ÁèæÂÆüÊ¥æÁ§æÂì°', icon: '012.png', baseStats: { stress: 75, knowledge: 80, physical: 70, communication: 70 } },
            { id: 'katei', name: 'ÂÆ∂Â∫≠„ÅåÂ§ß‰∫ãÁ§æÂì°', icon: '013.png', baseStats: { stress: 70, knowledge: 65, physical: 60, communication: 75 } },
            { id: 'balancer', name: '„Éê„É©„É≥„Çµ„ÉºÁ§æÂì°', icon: '014.png', baseStats: { stress: 75, knowledge: 75, physical: 75, communication: 75 } },
            { id: 'seika', name: 'ÊàêÊûúÊúÄÈÅ©ÂåñÁ§æÁïú', icon: '015.png', baseStats: { stress: 85, knowledge: 90, physical: 80, communication: 70 } },
            { id: 'jiyujin', name: 'Ëá™Áî±‰∫∫', icon: '016.png', baseStats: { stress: 60, knowledge: 70, physical: 80, communication: 85 } }
        ];

        // „Ç≤„Éº„É†Áä∂ÊÖã
        let gameState = {
            selectedCharacter: null,
            shachi: GAME_CONFIG.INITIAL_SHACHI,
            level: 1,
            experience: 0,
            stats: {
                stress: 0,
                knowledge: 0,
                physical: 0,
                communication: 0
            },
            ownedCharacters: [],
            party: [],
            dailyEventsCompleted: 0,
            completedEventTypes: [], // ‰ªäÊó•ÂÆå‰∫Ü„Åó„Åü„Ç§„Éô„É≥„Éà„Çø„Ç§„Éó
            lastPlayDate: null,
            purchasedItems: [],
            totalDaysPlayed: 0,
            totalShachiEarned: 0,
            totalEventsCompleted: 0,
            totalItemsPurchased: 0,
            totalShachiSpent: 0,
            completedAchievements: [] // „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„ÉàÈÅîÊàê„É™„Çπ„Éà
        };

        let selectedCharacterId = null;

        // ÁîªÈù¢Ë°®Á§∫Âàá„ÇäÊõø„Åà
        function showScreen(screenName) {
            console.log('ÁîªÈù¢Âàá„ÇäÊõø„Åà:', screenName);
            
            // „Åô„Åπ„Å¶„ÅÆÁîªÈù¢„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            
            // ÊåáÂÆö„Åï„Çå„ÅüÁîªÈù¢„ÇíË°®Á§∫
            const targetScreen = document.getElementById(screenName);
            
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                console.log('ÁîªÈù¢Ë°®Á§∫ÂÆå‰∫Ü:', screenName);
                
                // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                updateNavigationActive(screenName);
                
                // ÁîªÈù¢„Åî„Å®„ÅÆÂàùÊúüÂåñÂá¶ÁêÜ
                switch(screenName) {
                    case 'main':
                        updateMainScreen();
                        break;
                    case 'events':
                        startEvent();
                        break;
                    case 'shop':
                        renderShop();
                        break;
                    case 'formation':
                        renderFormation();
                        break;
                    case 'settings':
                        updateGameStats();
                        renderAchievements();
                        break;
                }
            } else {
                console.error('ÁîªÈù¢„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', screenName);
                // Âà©Áî®ÂèØËÉΩ„Å™ÁîªÈù¢ID„Çí„É≠„Ç∞Âá∫Âäõ
                const availableScreens = Array.from(document.querySelectorAll('.screen')).map(s => s.id);
                console.log('Âà©Áî®ÂèØËÉΩ„Å™ÁîªÈù¢ID:', availableScreens);
            }
        }
        
        function updateNavigationActive(activeScreenId) {
            // „Åô„Åπ„Å¶„ÅÆ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„Åã„Çâactive„ÇØ„É©„Çπ„ÇíÂâäÈô§
            const allNavBtns = document.querySelectorAll('.nav-btn');
            allNavBtns.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ÁèæÂú®„ÅÆÁîªÈù¢„Å´ÂØæÂøú„Åô„Çã„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„Å´active„ÇØ„É©„Çπ„ÇíËøΩÂä†
            const activeNavBtn = document.querySelector(`[onclick="showScreen('${activeScreenId}')"]`);
            if (activeNavBtn) {
                activeNavBtn.classList.add('active');
            }
        }

        // „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû
        function selectCharacter(characterId) {
            console.log('„Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû:', characterId);
            selectedCharacterId = characterId;
            
            // Ââç„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
            document.querySelectorAll('.character-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Êñ∞„Åó„ÅÑÈÅ∏Êäû„ÇíËøΩÂä†
            const selectedCard = document.querySelector(`[data-character-id="${characterId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
            
            // „Éó„É¨„Éì„É•„Éº„ÇíÊõ¥Êñ∞
            updateCharacterPreview(characterId);
            
            // Á¢∫ÂÆö„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
            const confirmBtn = document.getElementById('confirm-character');
            if (confirmBtn) {
                confirmBtn.disabled = false;
            }
        }

        // „Ç≠„É£„É©„ÇØ„Çø„Éº„Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞
        function updateCharacterPreview(characterId) {
            const character = CHARACTERS.find(c => c.id === characterId);
            if (!character) return;
            
            document.getElementById('preview-name').textContent = character.name;
            document.querySelector('.preview-image').innerHTML = `
                <img src="10_Á§æÁïú„Ç¢„Ç§„Ç≥„É≥/${character.icon}" alt="${character.name}" loading="lazy" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div style="width: 100%; height: 100%; background: #ddd; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 48px; color: #666;">
                    ${character.name.charAt(0)}
                </div>
            `;
            document.getElementById('preview-stress').textContent = character.baseStats.stress;
            document.getElementById('preview-knowledge').textContent = character.baseStats.knowledge;
            document.getElementById('preview-physical').textContent = character.baseStats.physical;
            document.getElementById('preview-communication').textContent = character.baseStats.communication;
        }

        // „Ç≠„É£„É©„ÇØ„Çø„ÉºÁ¢∫ÂÆö
        function confirmCharacter() {
            console.log('„Ç≠„É£„É©„ÇØ„Çø„ÉºÁ¢∫ÂÆöÈñãÂßã:', selectedCharacterId);
            
            if (!selectedCharacterId) {
                console.error('„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                alert('„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const character = CHARACTERS.find(c => c.id === selectedCharacterId);
            if (!character) {
                console.error('„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', selectedCharacterId);
                alert('„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            console.log('ÈÅ∏Êäû„Åï„Çå„Åü„Ç≠„É£„É©„ÇØ„Çø„Éº:', character);
            
            // „Ç≤„Éº„É†Áä∂ÊÖã„ÇíÊõ¥Êñ∞
            gameState.selectedCharacter = character;
            // „Çπ„ÉÜ„Éº„Çø„Çπ„ÅØ0„Åã„Çâ„Çπ„Çø„Éº„ÉàÔºà„É¨„Éô„É´1„Åã„ÇâÈñãÂßãÔºâ
            gameState.stats = {
                stress: 0,
                knowledge: 0,
                physical: 0,
                communication: 0
            };
            gameState.level = 1; // ÊúÄÂàù„ÅØ„É¨„Éô„É´1
            gameState.ownedCharacters = [character];
            gameState.party = [character];
            
            console.log('„Ç≤„Éº„É†Áä∂ÊÖãÊõ¥Êñ∞ÂÆå‰∫Ü:', gameState);
            
            // „É°„Ç§„É≥ÁîªÈù¢„Å´ÁßªÂãï
            console.log('„É°„Ç§„É≥ÁîªÈù¢„Å´Âàá„ÇäÊõø„Åà‰∏≠...');
            showScreen('main');
            
            // „É°„Ç§„É≥ÁîªÈù¢„ÇíÊõ¥Êñ∞
            updateMainScreen();
            
            // Ëá™Âãï„Çª„Éº„Éñ
            autoSave();
            
            alert(`${character.name}„Åß„Ç≤„Éº„É†„ÇíÈñãÂßã„Åó„Åæ„Åó„ÅüÔºÅ`);
        }

        // DOMÊõ¥Êñ∞„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•ÔºàÂÜçÊèèÁîª„ÇíÈò≤„ÅêÔºâ
        let lastRenderedState = {
            shachi: null,
            level: null,
            stats: null
        };
        
        // „É°„Ç§„É≥ÁîªÈù¢Êõ¥Êñ∞
        async function updateMainScreen() {
            console.log('„É°„Ç§„É≥ÁîªÈù¢Êõ¥Êñ∞ÈñãÂßã');
            
            if (!gameState.selectedCharacter) {
                console.error('ÈÅ∏Êäû„Åï„Çå„Åü„Ç≠„É£„É©„ÇØ„Çø„Éº„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            const character = gameState.selectedCharacter;
            console.log('Êõ¥Êñ∞„Åô„Çã„Ç≠„É£„É©„ÇØ„Çø„Éº:', character);
            
            // Â§âÊõ¥„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊõ¥Êñ∞„Çí„Çπ„Ç≠„ÉÉ„Éó
            const hasChanges = 
                lastRenderedState.shachi !== gameState.shachi ||
                lastRenderedState.level !== gameState.level ||
                JSON.stringify(lastRenderedState.stats) !== JSON.stringify(gameState.stats);
            
            if (!hasChanges && lastRenderedState.shachi !== null) {
                console.log('Â§âÊõ¥„Åå„Å™„ÅÑ„Åü„ÇÅ„ÄÅÊõ¥Êñ∞„Çí„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }
            
            // „Ç≠„É£„É©„ÇØ„Çø„ÉºÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            const characterNameEl = document.getElementById('character-name');
            const characterImageEl = document.getElementById('main-character-image');
            const characterLevelEl = document.getElementById('character-level');
            const currencyAmountEl = document.getElementById('currency-amount');
            
            if (characterNameEl) {
                characterNameEl.textContent = character.name;
                console.log('„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêçÊõ¥Êñ∞:', character.name);
            }
            
            if (characterImageEl) {
                characterImageEl.innerHTML = `
                    <img src="10_Á§æÁïú„Ç¢„Ç§„Ç≥„É≥/${character.icon}" alt="${character.name}" loading="lazy" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div style="width: 100%; height: 100%; background: #ddd; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 48px; color: #666;">
                        ${character.name.charAt(0)}
                    </div>
                `;
                console.log('„Ç≠„É£„É©„ÇØ„Çø„ÉºÁîªÂÉèÊõ¥Êñ∞:', character.name);
            }
            
            if (characterLevelEl) {
                characterLevelEl.textContent = gameState.level;
                console.log('„É¨„Éô„É´Êõ¥Êñ∞:', gameState.level);
            }
            
            if (currencyAmountEl) {
                currencyAmountEl.textContent = gameState.shachi;
                console.log('ÈÄöË≤®Êõ¥Êñ∞:', gameState.shachi);
            }
            
            // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
            await updateStatsDisplay();
            console.log('„É°„Ç§„É≥ÁîªÈù¢Êõ¥Êñ∞ÂÆå‰∫Ü');
            
            // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞
            lastRenderedState = {
                shachi: gameState.shachi,
                level: gameState.level,
                stats: {...gameState.stats}
            };
        }

        // „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºàÈÄöÁü•„Å™„Åó„É¢„Éº„ÉâÔºâ
        let isInitialLoad = true;
        
        async function checkAchievements(silent = false) {
            ACHIEVEMENTS.forEach(achievement => {
                const current = getCurrentAchievementProgress(achievement);
                
                // ÈÅîÊàêÊù°‰ª∂„ÇíÊ∫Ä„Åü„Åó„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (current >= achievement.target) {
                    // Êó¢„Å´ÈÅîÊàêÊ∏à„Åø„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    if (!gameState.completedAchievements || !gameState.completedAchievements.includes(achievement.id)) {
                        // „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„ÉàÈÅîÊàêÔºà„Çµ„Ç§„É¨„É≥„Éà„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØÈÄöÁü•„Çí„Çπ„Ç≠„ÉÉ„ÉóÔºâ
                        completeAchievement(achievement, current, silent);
                    }
                }
            });
            
            isInitialLoad = false;
        }
        
        // „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà„ÅÆÁèæÂú®„ÅÆÈÄ≤Êçó„ÇíÂèñÂæó
        function getCurrentAchievementProgress(achievement) {
            switch (achievement.type) {
                case 'level':
                    return gameState.level || 0;
                case 'events':
                    return gameState.totalEventsCompleted || 0;
                case 'items':
                    return gameState.totalItemsPurchased || 0;
                case 'shachi':
                    return gameState.totalShachiEarned || 0;
                default:
                    return 0;
            }
        }
        
        // „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„ÉàÈÅîÊàêÂá¶ÁêÜ
        async function completeAchievement(achievement, currentValue, silent = false) {
            console.log('„Ç¢„ÉÅ„Éº„Éñ„É°„É≥„ÉàÈÅîÊàê:', achievement);
            
            // ÈÅîÊàê„É™„Çπ„Éà„Å´ËøΩÂä†
            if (!gameState.completedAchievements) {
                gameState.completedAchievements = [];
            }
            gameState.completedAchievements.push(achievement.id);
            
            // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´‰øùÂ≠ò
            await saveAchievementToDatabase(achievement, currentValue);
            
            // ÈÅîÊàêÈÄöÁü•„ÇíË°®Á§∫Ôºà„Çµ„Ç§„É¨„É≥„Éà„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºâ
            if (!silent) {
                showAchievementNotification(achievement, currentValue);
            }
            
            // Ëá™Âãï„Çª„Éº„Éñ
            autoSave();
        }
        
        // „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„ÉàÈÅîÊàêÈÄöÁü•„ÇíË°®Á§∫
        function showAchievementNotification(achievement, currentValue) {
            const dialog = document.createElement('div');
            dialog.className = 'achievement-notification';
            dialog.innerHTML = `
                <div class="achievement-content">
                    <div class="achievement-icon">${achievement.icon}</div>
                    <h3>„Ç¢„ÉÅ„Éº„Éñ„É°„É≥„ÉàÈÅîÊàêÔºÅ</h3>
                    <p class="achievement-name">${achievement.name}</p>
                    <p class="achievement-description">${achievement.description}</p>
                    <p class="achievement-progress">ÈÄ≤Êçó: ${currentValue}/${achievement.target}</p>
                    <button class="btn-primary" onclick="this.parentElement.parentElement.remove();">Èñâ„Åò„Çã</button>
                </div>
            `;
            document.body.appendChild(dialog);
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            setTimeout(() => {
                dialog.style.opacity = '1';
                dialog.style.transform = 'scale(1)';
            }, 10);
        }
        
        // „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà‰∏ÄË¶ß„ÇíË°®Á§∫
        function renderAchievements() {
            const list = document.getElementById('achievement-list');
            if (!list) return;
            
            list.innerHTML = '';
            
            ACHIEVEMENTS.forEach(achievement => {
                const current = getCurrentAchievementProgress(achievement);
                const completed = gameState.completedAchievements && gameState.completedAchievements.includes(achievement.id);
                const progress = Math.min(100, (current / achievement.target) * 100);
                
                const item = document.createElement('div');
                item.className = 'achievement-item';
                if (completed) {
                    item.classList.add('completed');
                }
                
                item.innerHTML = `
                    <div class="achievement-item-icon">${achievement.icon}</div>
                    <div class="achievement-item-info">
                        <h4 class="achievement-item-name">${achievement.name}</h4>
                        <p class="achievement-item-description">${achievement.description}</p>
                        <div class="achievement-progress-bar">
                            <div class="achievement-progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <p class="achievement-progress-text">ÈÅîÊàê: ${completed ? '‚úì ÂÆå‰∫ÜÊ∏à„Åø' : `${current}/${achievement.target}`}</p>
                    </div>
                    ${completed ? '<div class="achievement-checkmark">‚úì</div>' : ''}
                `;
                
                list.appendChild(item);
            });
        }
        
        // „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà„Çí„Éá„Éº„Çø„Éô„Éº„Çπ„Å´‰øùÂ≠ò
        async function saveAchievementToDatabase(achievement, currentValue) {
            if (useLocalMode || !supabase || !isAuthenticated) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('user_achievements')
                    .upsert({
                        user_id: currentUser.id,
                        achievement_id: achievement.id,
                        achievement_name: achievement.name,
                        achievement_description: achievement.description,
                        achievement_type: achievement.type,
                        target_value: achievement.target,
                        current_value: currentValue,
                        is_completed: true,
                        completed_at: new Date().toISOString(),
                        reward: {}
                    }, {
                        onConflict: 'user_id,achievement_id'
                    });
                
                if (error) {
                    console.error('„Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà‰øùÂ≠ò„Ç®„É©„Éº:', error);
                } else {
                    console.log('„Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà‰øùÂ≠òÊàêÂäü');
                }
            } catch (error) {
                console.error('„Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }
        
        // „É¨„Éô„É´„ÇíË®àÁÆó
        async function calculateLevel() {
            const stats = gameState.stats;
            const totalStats = (stats.stress || 0) + (stats.knowledge || 0) + 
                             (stats.physical || 0) + (stats.communication || 0);
            const newLevel = Math.floor(totalStats / 40) + 1;
            
            // „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÂà§ÂÆö
            if (newLevel > gameState.level && gameState.level > 0) {
                const levelDiff = newLevel - gameState.level;
                const oldLevel = gameState.level;
                gameState.level = newLevel;
                
                // „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÊºîÂá∫„ÇíË°®Á§∫
                showLevelUpAnimation(oldLevel, newLevel);
                
                // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´„É¨„Éô„É´„Ç¢„ÉÉ„Éó„ÇíË®òÈå≤
                await recordLevelUp(oldLevel, newLevel);
                
                // „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                await checkAchievements();
                
                showToast(`„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ„É¨„Éô„É´${oldLevel}„Åã„Çâ${newLevel}„Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ`, 'success');
                console.log(`„É¨„Éô„É´${oldLevel}„Åã„Çâ${newLevel}„Å´„Ç¢„ÉÉ„ÉóÔºÅ`);
            } else {
                gameState.level = newLevel;
            }
            
            return newLevel;
        }
        
        // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„Çí„Éá„Éº„Çø„Éô„Éº„Çπ„Å´Ë®òÈå≤
        async function recordLevelUp(oldLevel, newLevel) {
            if (useLocalMode || !supabase || !isAuthenticated) {
                return;
            }
            
            try {
                // user_game_stats„ÉÜ„Éº„Éñ„É´„ÅÆhighest_level_reached„ÇíÊõ¥Êñ∞
                const { error } = await supabase
                    .from('user_game_stats')
                    .upsert({
                        user_id: currentUser.id,
                        highest_level_reached: newLevel,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });
                
                if (error) {
                    console.error('„É¨„Éô„É´„Ç¢„ÉÉ„ÉóË®òÈå≤„Ç®„É©„Éº:', error);
                } else {
                    console.log('„É¨„Éô„É´„Ç¢„ÉÉ„ÉóË®òÈå≤ÊàêÂäü');
                }
            } catch (error) {
                console.error('„É¨„Éô„É´„Ç¢„ÉÉ„ÉóË®òÈå≤„Ç®„É©„Éº:', error);
            }
        }
        
        // „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÊºîÂá∫„ÇíË°®Á§∫
        function showLevelUpAnimation(oldLevel, newLevel) {
            const dialog = document.createElement('div');
            dialog.className = 'level-up-dialog';
            dialog.innerHTML = `
                <div class="level-up-content">
                    <div class="level-up-icon">üéâ</div>
                    <h2>„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ</h2>
                    <div class="level-up-animation">
                        <span class="old-level">Level ${oldLevel}</span>
                        <span class="arrow">‚Üí</span>
                        <span class="new-level">Level ${newLevel}</span>
                    </div>
                    <p class="level-up-message">„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ</p>
                    <button class="btn-primary" onclick="this.parentElement.parentElement.remove();">Èñâ„Åò„Çã</button>
                </div>
            `;
            document.body.appendChild(dialog);
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            setTimeout(() => {
                dialog.style.opacity = '1';
                dialog.style.transform = 'scale(1)';
            }, 10);
        }
        
        // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫Êõ¥Êñ∞
        async function updateStatsDisplay() {
            console.log('„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫Êõ¥Êñ∞ÈñãÂßã');
            
            // „É¨„Éô„É´„ÇíË®àÁÆó
            await calculateLevel();
            
            const stats = gameState.stats;
            const statNames = ['stress', 'knowledge', 'physical', 'communication'];
            
            statNames.forEach((stat, index) => {
                const value = Math.max(0, stats[stat] || 0); // Ë≤†„ÅÆÂÄ§„Çí0„Å´Âà∂Èôê
                const percentage = Math.min(100, (value / 100) * 100); // 100%„ÇíË∂Ö„Åà„Å™„ÅÑ„Çà„ÅÜ„Å´Âà∂Èôê
                
                const statBar = document.getElementById(`${stat}-bar`);
                const statValue = document.getElementById(`${stat}-value`);
                
                if (statBar) {
                    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„Åç„ÅßÊõ¥Êñ∞
                    statBar.style.transition = 'width 1s ease-out';
                    statBar.style.width = `${percentage}%`;
                    console.log(`${stat}„Éê„ÉºÊõ¥Êñ∞:`, percentage + '%');
                    
                    // Ëâ≤„ÅÆÂ§âÂåñ„Çí„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                    setTimeout(() => {
                        statBar.style.transition = 'background-color 0.3s ease';
                        statBar.style.backgroundColor = '#28a745';
                        setTimeout(() => {
                            statBar.style.backgroundColor = '';
                        }, 300);
                    }, 100);
                }
                if (statValue) {
                    statValue.textContent = value; // Áõ¥Êé•Êõ¥Êñ∞ÔºàË≤†„ÅÆÂÄ§„Çí0„Å´Ë°®Á§∫Ôºâ
                }
            });
            
            // „É¨„Éô„É´Ë°®Á§∫„ÇíÊõ¥Êñ∞
            const levelElement = document.getElementById('character-level');
            if (levelElement) {
                levelElement.textContent = `„É¨„Éô„É´${gameState.level}`;
            }
        }
        
        // Êï∞ÂÄ§„ÅÆ„Ç´„Ç¶„É≥„Éà„Ç¢„ÉÉ„Éó„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        function animateNumber(element, targetValue, duration) {
            const startValue = parseInt(element.textContent) || 0;
            const increment = targetValue > startValue ? 1 : -1;
            const steps = Math.abs(targetValue - startValue);
            const stepTime = duration / steps;
            
            let currentValue = startValue;
            const interval = setInterval(() => {
                currentValue += increment;
                element.textContent = currentValue;
                
                if (currentValue === targetValue) {
                    clearInterval(interval);
                }
            }, stepTime);
        }

        // „Ç≠„É£„É©„ÇØ„Çø„Éº„Ç∞„É™„ÉÉ„Éâ‰ΩúÊàê
        function createCharacterGrid() {
            console.log('„Ç≠„É£„É©„ÇØ„Çø„Éº„Ç∞„É™„ÉÉ„Éâ‰ΩúÊàêÈñãÂßã');
            const grid = document.getElementById('character-grid');
            if (!grid) {
                console.error('character-gridË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            grid.innerHTML = '';
            
            CHARACTERS.forEach(character => {
                console.log('„Ç≠„É£„É©„ÇØ„Çø„Éº„Ç´„Éº„Éâ‰ΩúÊàê:', character.name);
                const card = document.createElement('div');
                card.className = 'character-card';
                card.dataset.characterId = character.id;
                card.innerHTML = `
                    <div class="character-icon">
                        <img src="10_Á§æÁïú„Ç¢„Ç§„Ç≥„É≥/${character.icon}" alt="${character.name}" loading="lazy" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="width: 100%; height: 100%; background: #ddd; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 24px; color: #666;">
                            ${character.name.charAt(0)}
                        </div>
                    </div>
                    <div class="character-name">${character.name}</div>
                    <div class="character-level">Lv.1</div>
                `;
                
                card.addEventListener('click', () => {
                    console.log('„Ç≠„É£„É©„ÇØ„Çø„Éº„Ç´„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØ:', character.id);
                    selectCharacter(character.id);
                });
                grid.appendChild(card);
            });
            
            console.log('„Ç≠„É£„É©„ÇØ„Çø„Éº„Ç∞„É™„ÉÉ„Éâ‰ΩúÊàêÂÆå‰∫Ü');
        }

        // „Éà„Éº„Çπ„ÉàË°®Á§∫
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // „Ç≤„Éº„É†„Éá„Éº„Çø„ÅÆ„É≠„Éº„Éâ
        async function loadGameData() {
            // Ë™çË®ºÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅÆ„ÅøSupabase„Åã„ÇâË™≠„ÅøËæº„Åø
            if (isAuthenticated && supabase) {
                const supabaseData = await loadGameDataFromSupabase();
                if (supabaseData) {
                    // Supabase„ÅÆ„Éá„Éº„Çø„Çí‰ΩøÁî®
                    gameState = {
                        selectedCharacter: supabaseData.selectedCharacter || null,
                        shachi: supabaseData.shachi || GAME_CONFIG.INITIAL_SHACHI,
                        level: supabaseData.level || 1,
                        experience: supabaseData.experience || 0,
                        stats: supabaseData.stats || { stress: 0, knowledge: 0, physical: 0, communication: 0 },
                        ownedCharacters: supabaseData.ownedCharacters || [],
                        party: supabaseData.party || [],
                        dailyEventsCompleted: supabaseData.dailyEventsCompleted || 0,
                        completedEventTypes: supabaseData.completedEventTypes || [],
                        lastPlayDate: supabaseData.lastPlayDate || null,
                        purchasedItems: supabaseData.purchasedItems || [],
                        totalDaysPlayed: supabaseData.totalDaysPlayed || 0,
                        totalShachiEarned: supabaseData.totalShachiEarned || 0,
                        totalEventsCompleted: supabaseData.totalEventsCompleted || 0,
                        totalItemsPurchased: supabaseData.totalItemsPurchased || 0,
                        totalShachiSpent: supabaseData.totalShachiSpent || 0
                    };
                    console.log('Supabase„Åã„Çâ„Ç≤„Éº„É†„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü:', gameState);
                    return;
                } else {
                    // Supabase„Å´„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅ„É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÁßªË°å
                    console.log('Supabase„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÁßªË°å„Åó„Åæ„Åô„ÄÇ');
                    await migrateLocalDataToSupabase();
                }
            }
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË™≠„ÅøËæº„Åø
            const savedData = localStorage.getItem('shachipoke2_save');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    gameState = {
                        selectedCharacter: parsedData.selectedCharacter || null,
                        shachi: parsedData.shachi || GAME_CONFIG.INITIAL_SHACHI,
                        level: parsedData.level || 1,
                        experience: parsedData.experience || 0,
                        stats: parsedData.stats || { stress: 0, knowledge: 0, physical: 0, communication: 0 },
                        ownedCharacters: parsedData.ownedCharacters || [],
                        party: parsedData.party || [],
                        dailyEventsCompleted: parsedData.dailyEventsCompleted || 0,
                        completedEventTypes: parsedData.completedEventTypes || [],
                        lastPlayDate: parsedData.lastPlayDate || null,
                        purchasedItems: parsedData.purchasedItems || [],
                        totalDaysPlayed: parsedData.totalDaysPlayed || 0,
                        totalShachiEarned: parsedData.totalShachiEarned || 0,
                        totalEventsCompleted: parsedData.totalEventsCompleted || 0,
                        totalItemsPurchased: parsedData.totalItemsPurchased || 0,
                        totalShachiSpent: parsedData.totalShachiSpent || 0
                    };
                    console.log('„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„Ç≤„Éº„É†„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü:', gameState);
                } catch (error) {
                    console.error('„Ç≤„Éº„É†„Éá„Éº„Çø„ÅÆ„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
                    resetGameState();
                }
            } else {
                console.log('„Çª„Éº„Éñ„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì - Êñ∞Ë¶è„Ç≤„Éº„É†ÈñãÂßã');
                resetGameState();
            }
        }
        
        // „Ç≤„Éº„É†Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
        function resetGameState() {
            gameState = {
                selectedCharacter: null,
                shachi: GAME_CONFIG.INITIAL_SHACHI,
                level: 1,
                experience: 0,
                stats: { stress: 0, knowledge: 0, physical: 0, communication: 0 },
                ownedCharacters: [],
                party: [],
                dailyEventsCompleted: 0,
                completedEventTypes: [], // ÂÆå‰∫Ü„Åó„Åü„Ç§„Éô„É≥„Éà„Çø„Ç§„Éó
                lastPlayDate: null,
                purchasedItems: [],
                totalDaysPlayed: 0,
                totalShachiEarned: 0,
                totalEventsCompleted: 0,
                totalItemsPurchased: 0,
                totalShachiSpent: 0
            };
        }
        
        // „Ç≤„Éº„É†„Éá„Éº„Çø„ÅÆ„Çª„Éº„Éñ
        async function saveGameData() {
            try {
                // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
                localStorage.setItem('shachipoke2_save', JSON.stringify(gameState));
                console.log('„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', gameState);
                
                // Supabase„Å´„ÇÇ‰øùÂ≠òÔºàË™çË®ºÊ∏à„Åø„ÅÆÂ†¥ÂêàÔºâ
                if (isAuthenticated) {
                    await saveGameDataToSupabase();
                }
                
                return true;
            } catch (error) {
                console.error('„Ç≤„Éº„É†„Éá„Éº„Çø„ÅÆ„Çª„Éº„Éñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
                alert('„Ç≤„Éº„É†„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆ„Çπ„Éà„É¨„Éº„Ç∏ÂÆπÈáè„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return false;
            }
        }
        
        // Ëá™Âãï„Çª„Éº„ÉñÊ©üËÉΩ
        async function autoSave() {
            if (gameState.selectedCharacter) {
                await saveGameData();
            }
        }
        
        // Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÊ©üËÉΩÔºà5ÂàÜ„Åî„Å®Ôºâ
        let lastBackupTime = 0;
        const BACKUP_INTERVAL = 5 * 60 * 1000; // 5ÂàÜ
        
        function checkAutoBackup() {
            const now = Date.now();
            if (now - lastBackupTime >= BACKUP_INTERVAL && gameState.selectedCharacter) {
                console.log('Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÂÆüË°å„Åó„Åæ„Åô');
                saveGameData();
                lastBackupTime = now;
            }
        }
        
        // 5ÂàÜ„Åî„Å®„Å´Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        setInterval(checkAutoBackup, 60000); // 1ÂàÜ„Åî„Å®„Å´„ÉÅ„Çß„ÉÉ„ÇØ
        
        // Êó•Êõø„Çè„Çä„É™„Çª„ÉÉ„Éà„ÉÅ„Çß„ÉÉ„ÇØ
        function checkDailyReset() {
            const today = new Date().toDateString();
            if (gameState.lastPlayDate !== today) {
                gameState.dailyEventsCompleted = 0;
                gameState.completedEventTypes = []; // ‰ªäÊó•ÂÆå‰∫Ü„Åó„Åü„Ç§„Éô„É≥„Éà„Çø„Ç§„Éó„Çí„É™„Çª„ÉÉ„Éà
                gameState.lastPlayDate = today;
                gameState.totalDaysPlayed++;
                saveGameData();
                console.log('Êó•Êõø„Çè„Çä„É™„Çª„ÉÉ„ÉàÂÆå‰∫Ü');
            }
        }
        
        // „Ç§„Éô„É≥„Éà„Ç∑„Çπ„ÉÜ„É†
        function startEvent() {
            if (gameState.dailyEventsCompleted >= GAME_CONFIG.MAX_DAILY_EVENTS) {
                document.getElementById('event-selection').style.display = 'none';
                document.getElementById('current-event').style.display = 'none';
                document.getElementById('event-complete').style.display = 'none';
                document.getElementById('no-events').style.display = 'block';
                return;
            }
            
            // „Ç§„Éô„É≥„ÉàÈÅ∏ÊäûÁîªÈù¢„ÇíË°®Á§∫
            document.getElementById('event-selection').style.display = 'block';
            document.getElementById('current-event').style.display = 'none';
            document.getElementById('event-complete').style.display = 'none';
            document.getElementById('no-events').style.display = 'none';
            
            // „Ç§„Éô„É≥„Éà„Ç´„Éº„Éâ„ÇíÂãïÁöÑ„Å´ÁîüÊàê
            renderEventCards();
        }
        
        // „Ç§„Éô„É≥„Éà„Ç´„Éº„Éâ„ÇíÊèèÁîª
        function renderEventCards() {
            const eventTypesContainer = document.getElementById('event-types');
            if (!eventTypesContainer) return;
            
            eventTypesContainer.innerHTML = '';
            
            const eventTypes = [
                { id: 'boss_interaction', icon: 'üëî', title: '‰∏äÂè∏„ÅåË©±„Åó„Åã„Åë„Å¶„Åç„ÅüÔºÅ', description: '‰∏äÂè∏„Å®„ÅÆ„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥' },
                { id: 'office_politics', icon: 'üë©‚Äçüíº', title: '„ÅäÂ±ÄÊßò„Åã„Çâ„ÅÆÂ´åÂë≥', description: 'ËÅ∑Â†¥„ÅÆ‰∫∫ÈñìÈñ¢‰øÇ' },
                { id: 'customer_service', icon: 'üìû', title: '„Ç´„Çπ„Éè„É©ÂÆ¢„Åã„Çâ„ÅÆÈõªË©±', description: '„ÇØ„É¨„Éº„É†ÂØæÂøú' }
            ];
            
            // completedEventTypes„ÅåÊú™ÂàùÊúüÂåñ„ÅÆÂ†¥Âêà„ÄÅÂàùÊúüÂåñ
            if (!gameState.completedEventTypes) {
                gameState.completedEventTypes = [];
            }
            
            eventTypes.forEach(eventType => {
                const isCompleted = gameState.completedEventTypes.includes(eventType.id);
                const card = document.createElement('div');
                card.className = `event-type-card ${isCompleted ? 'completed' : ''}`;
                card.onclick = isCompleted ? null : () => selectEventType(eventType.id);
                card.innerHTML = `
                    <div class="event-icon">${eventType.icon}</div>
                    <h4>${eventType.title}</h4>
                    <p>${eventType.description}</p>
                    ${isCompleted ? '<div class="completed-badge">ÂÆå‰∫ÜÊ∏à„Åø</div>' : ''}
                `;
                eventTypesContainer.appendChild(card);
            });
        }
        
        function selectEventType(eventType) {
            console.log('„Ç§„Éô„É≥„Éà„Çø„Ç§„ÉóÈÅ∏Êäû:', eventType);
            
            // completedEventTypes„ÅåÊú™ÂàùÊúüÂåñ„ÅÆÂ†¥Âêà„ÄÅÂàùÊúüÂåñ
            if (!gameState.completedEventTypes) {
                gameState.completedEventTypes = [];
            }
            
            // Êó¢„Å´ÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Çã„Ç§„Éô„É≥„Éà„Çø„Ç§„Éó„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (gameState.completedEventTypes.includes(eventType)) {
                showToast('„Åì„ÅÆ„Ç§„Éô„É≥„Éà„ÅØ‰ªäÊó•„ÅØÊó¢„Å´ÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åô', 'warning');
                return;
            }
            
            const event = DAILY_EVENTS.find(e => e.id === eventType);
            if (!event) {
                console.error('„Ç§„Éô„É≥„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', eventType);
                return;
            }
            
            // ÈÅ∏Êäû‰∏≠„ÅÆ„Ç§„Éô„É≥„ÉàÊÉÖÂ†±„Çí‰øùÂ≠ò
            selectedEventType = eventType;
            currentSelectedEventId = event.id;
            
            // „Ç§„Éô„É≥„ÉàÈÅ∏ÊäûÁîªÈù¢„ÇíÈùûË°®Á§∫
            document.getElementById('event-selection').style.display = 'none';
            
            // „Ç§„Éô„É≥„ÉàË©≥Á¥∞ÁîªÈù¢„ÇíË°®Á§∫
            document.getElementById('event-title').textContent = event.title;
            document.getElementById('event-description').textContent = event.description;
            
            const choicesContainer = document.getElementById('event-choices');
            choicesContainer.innerHTML = '';
            
            event.choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = 'event-choice-btn';
                button.textContent = choice.text;
                button.onclick = () => selectEventChoice(choice, index);
                choicesContainer.appendChild(button);
            });
            
            document.getElementById('current-event').style.display = 'block';
        }
        
        async function selectEventChoice(choice, choiceIndex) {
            console.log('„Ç§„Éô„É≥„ÉàÈÅ∏ÊäûÂá¶ÁêÜÈñãÂßã:', choice, 'index:', choiceIndex);
            
            // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆ„Ç§„Éô„É≥„ÉàÊÉÖÂ†±„ÇíÂèñÂæó
            const currentEventType = selectedEventType || 'unknown';
            const currentEventId = currentSelectedEventId || currentEventType;
            
            // ÂäπÊûú„ÇíÈÅ©Áî®
            const statChanges = {};
            if (choice.effect.shachi) {
                gameState.shachi += choice.effect.shachi;
                gameState.totalShachiEarned += Math.max(0, choice.effect.shachi);
            }
            
            Object.keys(choice.effect).forEach(stat => {
                if (stat !== 'shachi' && gameState.stats[stat] !== undefined) {
                    const oldValue = gameState.stats[stat];
                    gameState.stats[stat] = Math.max(0, Math.min(GAME_CONFIG.STAT_CAP, 
                        gameState.stats[stat] + choice.effect[stat]));
                    statChanges[stat] = gameState.stats[stat] - oldValue;
                }
            });
            
            // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫
            document.getElementById('event-feedback').textContent = choice.feedback;
            
            // Â†±ÈÖ¨Ë°®Á§∫
            const rewardsContainer = document.getElementById('event-rewards');
            rewardsContainer.innerHTML = '';
            
            if (choice.effect.shachi) {
                const reward = document.createElement('div');
                reward.textContent = `„Ç∑„É£„ÉÅ: ${choice.effect.shachi > 0 ? '+' : ''}${choice.effect.shachi}`;
                reward.className = choice.effect.shachi > 0 ? 'reward-positive' : 'reward-negative';
                rewardsContainer.appendChild(reward);
            }
            
            Object.keys(choice.effect).forEach(stat => {
                if (stat !== 'shachi' && choice.effect[stat] !== 0) {
                    const reward = document.createElement('div');
                    const statNames = { stress: '„Çπ„Éà„É¨„ÇπËÄêÊÄß', knowledge: 'Áü•Ë≠ò', physical: '‰ΩìÂäõ', communication: '„Ç≥„Éü„É•Âäõ' };
                    reward.textContent = `${statNames[stat]}: ${choice.effect[stat] > 0 ? '+' : ''}${choice.effect[stat]}`;
                    reward.className = choice.effect[stat] > 0 ? 'reward-positive' : 'reward-negative';
                    rewardsContainer.appendChild(reward);
                }
            });
            
            gameState.dailyEventsCompleted++;
            gameState.totalEventsCompleted++;
            
            // completedEventTypes„ÅåÊú™ÂàùÊúüÂåñ„ÅÆÂ†¥Âêà„ÄÅÂàùÊúüÂåñ
            if (!gameState.completedEventTypes) {
                gameState.completedEventTypes = [];
            }
            
            // ÂÆå‰∫Ü„Åó„Åü„Ç§„Éô„É≥„Éà„Çø„Ç§„Éó„ÇíË®òÈå≤
            if (!gameState.completedEventTypes.includes(currentEventType)) {
                gameState.completedEventTypes.push(currentEventType);
            }
            
            // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´„Ç§„Éô„É≥„ÉàÂ±•Ê≠¥„Çí‰øùÂ≠ò
            await saveEventToDatabase(currentEventId, currentEventType, choiceIndex,
                choice.effect, statChanges, choice.feedback);
            
            // Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            await updateGameStatsInDatabase();
            
            // „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            await checkAchievements();
            
            document.getElementById('current-event').style.display = 'none';
            document.getElementById('event-complete').style.display = 'block';
            document.getElementById('events-remaining').textContent = GAME_CONFIG.MAX_DAILY_EVENTS - gameState.dailyEventsCompleted;
            
            // „Ç§„Éô„É≥„Éà„Ç´„Éº„Éâ„ÇíÂÜçÊèèÁîªÔºà„Ç∞„É¨„Éº„Ç¢„Ç¶„ÉàÂèçÊò†„ÅÆ„Åü„ÇÅÔºâ
            renderEventCards();
            
            updateMainScreen();
            autoSave();
            
            console.log('„Ç§„Éô„É≥„ÉàÈÅ∏ÊäûÂá¶ÁêÜÂÆå‰∫Ü');
        }
        
        function nextEvent() {
            // „Ç´„Ç¶„É≥„Çø„Éº„ÅØÊó¢„Å´Â¢ó„Åà„Å¶„ÅÑ„Çã„ÅÆ„Åß„ÄÅ„Åì„Åì„Åß„ÅØÂ¢ó„ÇÑ„Åï„Å™„ÅÑ
            document.getElementById('events-remaining').textContent = GAME_CONFIG.MAX_DAILY_EVENTS - gameState.dailyEventsCompleted;
            
            if (gameState.dailyEventsCompleted >= GAME_CONFIG.MAX_DAILY_EVENTS) {
                // „Åô„Åπ„Å¶„ÅÆ„Ç§„Éô„É≥„Éà„ÅåÂÆå‰∫Ü
                document.getElementById('event-selection').style.display = 'none';
                document.getElementById('current-event').style.display = 'none';
                document.getElementById('event-complete').style.display = 'none';
                document.getElementById('no-events').style.display = 'block';
            } else {
                // Ê¨°„ÅÆ„Ç§„Éô„É≥„ÉàÈÅ∏ÊäûÁîªÈù¢„ÇíË°®Á§∫
                startEvent();
            }
        }
        
        // „Ç∑„Éß„ÉÉ„Éó„Ç∑„Çπ„ÉÜ„É†ÔºàÂ∑ÆÂàÜÊõ¥Êñ∞ÂØæÂøúÔºâ
        let lastShopState = {
            shachi: null,
            purchasedItems: null
        };
        
        function renderShop() {
            const container = document.getElementById('shop-items');
            
            // Â§âÊõ¥„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂÜçÊèèÁîª„Çí„Çπ„Ç≠„ÉÉ„Éó
            const hasChanges = 
                lastShopState.shachi !== gameState.shachi ||
                JSON.stringify(lastShopState.purchasedItems) !== JSON.stringify(gameState.purchasedItems);
            
            if (!hasChanges && lastShopState.shachi !== null) {
                return;
            }
            
            container.innerHTML = '';
            
            SHOP_ITEMS.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'shop-item-card';
                itemCard.innerHTML = `
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-description">${item.description}</div>
                    <div class="item-cost">${item.cost}„Ç∑„É£„ÉÅ</div>
                    <button class="btn-primary" onclick="purchaseItem('${item.id}')" 
                            ${gameState.shachi < item.cost ? 'disabled' : ''}>
                        ${gameState.shachi < item.cost ? '„Ç∑„É£„ÉÅ‰∏çË∂≥' : 'Ë≥ºÂÖ•'}
                    </button>
                `;
                container.appendChild(itemCard);
            });
            
            // Áä∂ÊÖã„ÇíË®òÈå≤
            lastShopState = {
                shachi: gameState.shachi,
                purchasedItems: [...gameState.purchasedItems]
            };
        }
        
        async function purchaseItem(itemId) {
            const item = SHOP_ITEMS.find(i => i.id === itemId);
            if (!item || gameState.shachi < item.cost) {
                if (!item) {
                    showToast('„Ç¢„Ç§„ÉÜ„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
                } else if (gameState.shachi < item.cost) {
                    showToast('„Ç∑„É£„ÉÅ„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô', 'warning');
                }
                return;
            }
            
            console.log('„Ç¢„Ç§„ÉÜ„É†Ë≥ºÂÖ•Âá¶ÁêÜÈñãÂßã:', item);
            
            // „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÂåñ„ÇíË®òÈå≤ÔºàË≥ºÂÖ•ÂâçÔºâ
            const statChanges = {};
            
            // „Çπ„ÉÜ„Éº„Çø„ÇπÂäπÊûú„ÇíÈÅ©Áî®
            Object.keys(item.effect).forEach(stat => {
                if (gameState.stats[stat] !== undefined) {
                    const oldValue = gameState.stats[stat];
                    gameState.stats[stat] = Math.max(0, Math.min(GAME_CONFIG.STAT_CAP, 
                        gameState.stats[stat] + item.effect[stat]));
                    statChanges[stat] = gameState.stats[stat] - oldValue;
                }
            });
            
            // „Ç∑„É£„ÉÅ„ÇíÊ∂àË≤ª
            gameState.shachi -= item.cost;
            gameState.purchasedItems.push(itemId);
            gameState.totalShachiSpent = (gameState.totalShachiSpent || 0) + item.cost;
            gameState.totalItemsPurchased = (gameState.totalItemsPurchased || 0) + 1;
            
            // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´Ë≥ºÂÖ•Â±•Ê≠¥„Çí‰øùÂ≠ò
            await savePurchaseToDatabase(itemId, item.name, item.cost, item.effect, statChanges);
            
            // Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            await updateGameStatsInDatabase();
            
            // „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            await checkAchievements();
            
            // Ë©≥Á¥∞„Å™Ë≥ºÂÖ•ÊàêÂäü„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
            showPurchaseSuccessDialog(item, statChanges);
            
            renderShop();
            updateMainScreen();
            autoSave();
            
            console.log('„Ç¢„Ç§„ÉÜ„É†Ë≥ºÂÖ•Âá¶ÁêÜÂÆå‰∫Ü');
        }
        
        // Á∑®Êàê„Ç∑„Çπ„ÉÜ„É†
        function renderFormation() {
            renderPartySlots();
            renderOwnedCharacters();
            renderPurchasableCharacters();
        }
        
        function renderPartySlots() {
            const container = document.getElementById('party-slots');
            container.innerHTML = '';
            
            for (let i = 0; i < 4; i++) {
                const slot = document.createElement('div');
                slot.className = 'party-slot';
                slot.innerHTML = `
                    <div class="slot-content">
                        ${gameState.party[i] ? `
                            <img src="10_Á§æÁïú„Ç¢„Ç§„Ç≥„É≥/${gameState.party[i].icon}" alt="${gameState.party[i].name}" loading="lazy">
                            <span>${gameState.party[i].name}</span>
                            <button onclick="removeFromParty(${i})">√ó</button>
                        ` : '<span>Á©∫„Åç„Çπ„É≠„ÉÉ„Éà</span>'}
                    </div>
                `;
                container.appendChild(slot);
            }
        }
        
        function renderOwnedCharacters() {
            const container = document.getElementById('owned-characters');
            container.innerHTML = '';
            
            gameState.ownedCharacters.forEach(character => {
                const card = document.createElement('div');
                card.className = 'character-card';
                card.innerHTML = `
                    <img src="10_Á§æÁïú„Ç¢„Ç§„Ç≥„É≥/${character.icon}" alt="${character.name}" loading="lazy"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div style="width: 80px; height: 80px; background: #ddd; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 32px; color: #666;">
                        ${character.name.charAt(0)}
                    </div>
                    <span>${character.name}</span>
                    <div class="character-card-buttons">
                        <button onclick="showCharacterDetails('${character.id}')" class="btn-detail">Ë©≥Á¥∞</button>
                        <button onclick="addToParty('${character.id}')" class="btn-add">Á∑®Êàê</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function renderPurchasableCharacters() {
            const container = document.getElementById('purchasable-characters');
            container.innerHTML = '';
            
            const purchasable = CHARACTERS.filter(char => 
                !gameState.ownedCharacters.some(owned => owned.id === char.id)
            );
            
            purchasable.forEach(character => {
                const card = document.createElement('div');
                card.className = 'character-card';
                card.innerHTML = `
                    <img src="10_Á§æÁïú„Ç¢„Ç§„Ç≥„É≥/${character.icon}" alt="${character.name}" loading="lazy">
                    <span>${character.name}</span>
                    <div class="character-cost">${GAME_CONFIG.CHARACTER_COST}„Ç∑„É£„ÉÅ</div>
                    <button class="btn-primary" onclick="purchaseCharacter('${character.id}')" 
                            ${gameState.shachi < GAME_CONFIG.CHARACTER_COST ? 'disabled' : ''}>
                        ${gameState.shachi < GAME_CONFIG.CHARACTER_COST ? '„Ç∑„É£„ÉÅ‰∏çË∂≥' : 'Ë≥ºÂÖ•'}
                    </button>
                `;
                container.appendChild(card);
            });
        }
        
        async function addToParty(characterId) {
            if (gameState.party.length >= 4) {
                showToast('„Éë„Éº„ÉÜ„Ç£„Éº„ÅØÊúÄÂ§ß4‰∫∫„Åæ„Åß„Åß„Åô', 'error');
                return;
            }
            
            const character = gameState.ownedCharacters.find(c => c.id === characterId);
            if (character) {
                gameState.party.push(character);
                
                // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´„Éë„Éº„ÉÜ„Ç£„ÉºÁ∑®Êàê„Çí‰øùÂ≠ò
                await savePartyToDatabase();
                
                renderFormation();
                autoSave();
            }
        }
        
        async function removeFromParty(slotIndex) {
            gameState.party.splice(slotIndex, 1);
            
            // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´„Éë„Éº„ÉÜ„Ç£„ÉºÁ∑®Êàê„Çí‰øùÂ≠ò
            await savePartyToDatabase();
            
            renderFormation();
            autoSave();
        }
        
        async function purchaseCharacter(characterId) {
            if (gameState.shachi < GAME_CONFIG.CHARACTER_COST) {
                showToast('„Ç∑„É£„ÉÅ„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô', 'warning');
                return;
            }
            
            const character = CHARACTERS.find(c => c.id === characterId);
            if (character) {
                console.log('„Ç≠„É£„É©„ÇØ„Çø„ÉºË≥ºÂÖ•Âá¶ÁêÜÈñãÂßã:', character);
                
                // „Ç∑„É£„ÉÅ„ÇíÊ∂àË≤ª
                gameState.shachi -= GAME_CONFIG.CHARACTER_COST;
                gameState.ownedCharacters.push(character);
                gameState.totalShachiSpent = (gameState.totalShachiSpent || 0) + GAME_CONFIG.CHARACTER_COST;
                gameState.totalCharactersOwned = (gameState.totalCharactersOwned || 0) + 1;
                
                // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´„Ç≠„É£„É©„ÇØ„Çø„ÉºÊâÄÊúâÊÉÖÂ†±„Çí‰øùÂ≠ò
                await saveCharacterToDatabase(character);
                
                // Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞
                await updateGameStatsInDatabase();
                
                showToast(`${character.name}„ÇíË≥ºÂÖ•„Åó„Åæ„Åó„ÅüÔºÅ`, 'success');
                renderFormation();
                updateMainScreen();
                autoSave();
                
                console.log('„Ç≠„É£„É©„ÇØ„Çø„ÉºË≥ºÂÖ•Âá¶ÁêÜÂÆå‰∫Ü');
            }
        }
        
        // Ë®≠ÂÆö„Ç∑„Çπ„ÉÜ„É†
        function saveGame() {
            if (saveGameData()) {
                showToast('„Ç≤„Éº„É†„Çí„Çª„Éº„Éñ„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
            } else {
                showToast('„Çª„Éº„Éñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        function loadGame() {
            loadGameData();
            updateMainScreen();
            updateGameStats();
            showToast('„Ç≤„Éº„É†„Çí„É≠„Éº„Éâ„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
        }
        
        function resetGame() {
            if (confirm('Êú¨ÂΩì„Å´„Ç≤„Éº„É†„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü\n„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÅåÂâäÈô§„Åï„Çå„ÄÅÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åó„Å´„Å™„Çä„Åæ„Åô„ÄÇ')) {
                // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Çí„ÇØ„É™„Ç¢
                localStorage.removeItem('shachipoke2_save');
                
                // Supabase„ÅÆ„Éá„Éº„Çø„ÇÇÂâäÈô§ÔºàË™çË®ºÊ∏à„Åø„ÅÆÂ†¥ÂêàÔºâ
                if (isAuthenticated && supabase) {
                    deleteSupabaseData();
                }
                
                // „Ç≤„Éº„É†Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                resetGameState();
                
                // „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏ÊäûÁîªÈù¢„Å´Êàª„Çã
                showScreen('character-selection');
                showToast('„Ç≤„Éº„É†„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
            }
        }
        
        // Supabase„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§
        async function deleteSupabaseData() {
            if (!isAuthenticated || !supabase || !currentUser) {
                return;
            }
            
            try {
                // game_saves„ÉÜ„Éº„Éñ„É´„Åã„Çâ„Éá„Éº„Çø„ÇíÂâäÈô§
                const { error } = await supabase
                    .from('game_saves')
                    .delete()
                    .eq('user_id', currentUser.id)
                    .eq('game_name', 'shachipoke2');
                
                if (error) {
                    console.error('Supabase„Éá„Éº„ÇøÂâäÈô§„Ç®„É©„Éº:', error);
                } else {
                    console.log('Supabase„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('Supabase„Éá„Éº„ÇøÂâäÈô§„Ç®„É©„Éº:', error);
            }
        }
        
        function updateGameStats() {
            document.getElementById('total-days').textContent = gameState.totalDaysPlayed;
            document.getElementById('total-shachi').textContent = gameState.totalShachiEarned;
            document.getElementById('total-events').textContent = gameState.totalEventsCompleted;
            document.getElementById('owned-count').textContent = gameState.ownedCharacters.length;
        }
        
        // ÂàùÊúüÂåñ
        // Ë™çË®ºÈñ¢ÈÄ£Èñ¢Êï∞
        async function checkAuthStatus() {
            if (useLocalMode) {
                console.log('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„ÅÆ„Åü„ÇÅ„ÄÅË™çË®º„ÉÅ„Çß„ÉÉ„ÇØ„Çí„Çπ„Ç≠„ÉÉ„Éó');
                isAuthenticated = false;
                currentUser = null;
                return false;
            }
            
            if (!supabase) {
                console.log('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
                return false;
            }
            
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error) {
                    console.error('Ë™çË®ºÁä∂ÊÖãÁ¢∫Ë™ç„Ç®„É©„Éº:', error);
                    isAuthenticated = false;
                    currentUser = null;
                    return false;
                }
                
                if (session) {
                    currentUser = session.user;
                    isAuthenticated = true;
                    console.log('Ë™çË®ºÊ∏à„Åø„É¶„Éº„Ç∂„Éº:', currentUser.email);
                    
                    // „Éó„É≠„Éï„Ç£„Éº„É´„ÇíËá™Âãï‰ΩúÊàê
                    await ensureUserProfile(currentUser);
                    
                    return true;
                } else {
                    currentUser = null;
                    isAuthenticated = false;
                    console.log('Êú™Ë™çË®ºÁä∂ÊÖã');
                    return false;
                }
            } catch (error) {
                console.error('Ë™çË®ºÁä∂ÊÖãÁ¢∫Ë™ç„Ç®„É©„Éº:', error);
                isAuthenticated = false;
                currentUser = null;
                return false;
            }
        }
        
        async function signInWithGoogle() {
            if (useLocalMode || !supabase) {
                console.log('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åæ„Åü„ÅØSupabaseÊé•Á∂ö„Å™„Åó„ÅÆ„Åü„ÇÅ„ÄÅË™çË®º„Çí„Çπ„Ç≠„ÉÉ„Éó');
                showToast('ÁèæÂú®„ÅØ„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„ÅßÂãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô', 'info');
                return;
            }
            
            try {
                // Supabase„ÅÆ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØURL„Çí‰ΩøÁî®Ôºà„Åô„Åπ„Å¶„ÅÆ„Éá„Éê„Ç§„Çπ„ÅßÂãï‰ΩúÔºâ
                const redirectUrl = window.location.origin.includes('localhost') || window.location.origin.includes('192.168')
                    ? `${window.location.origin}/working-game.html`
                    : `${SUPABASE_URL}/auth/v1/callback`;
                
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: redirectUrl
                    }
                });
                
                if (error) {
                    console.error('GoogleË™çË®º„Ç®„É©„Éº:', error);
                    showToast('Ë™çË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            } catch (error) {
                console.error('GoogleË™çË®º„Ç®„É©„Éº:', error);
                showToast('Ë™çË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        async function signOut() {
            if (useLocalMode || !supabase) {
                console.log('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åæ„Åü„ÅØSupabaseÊé•Á∂ö„Å™„Åó„ÅÆ„Åü„ÇÅ„ÄÅ„É≠„Ç∞„Ç¢„Ç¶„Éà„Çí„Çπ„Ç≠„ÉÉ„Éó');
                showToast('ÁèæÂú®„ÅØ„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„ÅßÂãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô', 'info');
                return;
            }
            
            try {
                const { error } = await supabase.auth.signOut();
                if (error) {
                    console.error('„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:', error);
                    showToast('„É≠„Ç∞„Ç¢„Ç¶„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                } else {
                    // Ë™çË®ºÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                    currentUser = null;
                    isAuthenticated = false;
                    
                    // „Ç≤„Éº„É†Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                    resetGameState();
                    
                    console.log('„É≠„Ç∞„Ç¢„Ç¶„ÉàÂÆå‰∫Ü');
                    showToast('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü', 'success');
                    
                    // „É≠„Ç∞„Ç§„É≥ÂøÖÈ†àÁîªÈù¢„Å´ÈÅ∑Áßª
                    showScreen('login-required');
                    
                    // Ë™çË®ºÁä∂ÊÖã„ÇíUI„Å´ÂèçÊò†
                    updateAuthStatus();
                }
            } catch (error) {
                console.error('„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:', error);
                showToast('„É≠„Ç∞„Ç¢„Ç¶„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        // Supabase„Å´„Ç≤„Éº„É†„Éá„Éº„Çø„Çí‰øùÂ≠ò
        async function saveGameDataToSupabase() {
            if (!isAuthenticated || !currentUser) {
                console.log('Êú™Ë™çË®ºÁä∂ÊÖã„ÅÆ„Åü„ÇÅSupabase‰øùÂ≠ò„Çí„Çπ„Ç≠„ÉÉ„Éó');
                return false;
            }
            
            try {
                const { data, error } = await supabase
                    .from('game_saves')
                    .upsert({
                        user_id: currentUser.id,
                        game_name: 'shachipoke2',
                        save_data: gameState,
                        version: '1.0.0',
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id,game_name'
                    });
                
                if (error) {
                    console.error('Supabase‰øùÂ≠ò„Ç®„É©„Éº:', error);
                    showToast('„ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    return false;
                }
                
                console.log('Supabase‰øùÂ≠òÊàêÂäü:', data);
                showToast('„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
                return true;
            } catch (error) {
                console.error('Supabase‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showToast('„ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                return false;
            }
        }
        
        // „Ç§„Éô„É≥„ÉàÂ±•Ê≠¥„Çí„Éá„Éº„Çø„Éô„Éº„Çπ„Å´‰øùÂ≠ò
        async function saveEventToDatabase(eventId, eventType, choiceIndex, rewards, statChanges, feedback) {
            if (useLocalMode || !supabase || !isAuthenticated) {
                console.log('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åæ„Åü„ÅØÊú™Ë™çË®ºÁä∂ÊÖã„ÅÆ„Åü„ÇÅ„ÄÅ„Ç§„Éô„É≥„ÉàÂ±•Ê≠¥‰øùÂ≠ò„Çí„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }
            
            try {
                console.log('„Ç§„Éô„É≥„ÉàÂ±•Ê≠¥„Çí‰øùÂ≠òÈñãÂßã:', { eventId, eventType, choiceIndex, rewards, statChanges });
                
                // event_history„ÉÜ„Éº„Éñ„É´„Å´‰øùÂ≠ò
                const { error } = await supabase
                    .from('event_history')
                    .insert({
                        user_id: currentUser.id,
                        event_id: eventId,
                        event_type: eventType,
                        choice_made: choiceIndex,
                        rewards: rewards,
                        stats_change: statChanges,
                        shachi_earned: rewards.shachi || 0
                    });
                
                if (error) {
                    console.error('„Ç§„Éô„É≥„ÉàÂ±•Ê≠¥‰øùÂ≠ò„Ç®„É©„Éº:', error);
                } else {
                    console.log('„Ç§„Éô„É≥„ÉàÂ±•Ê≠¥‰øùÂ≠òÊàêÂäü');
                }
            } catch (error) {
                console.error('„Ç§„Éô„É≥„ÉàÂ±•Ê≠¥‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }
        
        // „Ç≤„Éº„É†Áµ±Ë®àÊÉÖÂ†±„Çí„Éá„Éº„Çø„Éô„Éº„Çπ„Å´Êõ¥Êñ∞
        async function updateGameStatsInDatabase() {
            if (useLocalMode || !supabase || !isAuthenticated) {
                console.log('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åæ„Åü„ÅØÊú™Ë™çË®ºÁä∂ÊÖã„ÅÆ„Åü„ÇÅ„ÄÅÁµ±Ë®àÊõ¥Êñ∞„Çí„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }
            
            try {
                // user_game_stats„ÉÜ„Éº„Éñ„É´„ÇíÊõ¥Êñ∞„Åæ„Åü„ÅØ‰ΩúÊàê
                const { error: upsertError } = await supabase
                    .from('user_game_stats')
                    .upsert({
                        user_id: currentUser.id,
                        total_events_completed: gameState.totalEventsCompleted || 0,
                        total_shachi_earned: gameState.totalShachiEarned || 0,
                        total_items_purchased: gameState.totalItemsPurchased || 0,
                        total_shachi_spent: gameState.totalShachiSpent || 0,
                        total_characters_owned: gameState.ownedCharacters.length || 0,
                        last_play_date: new Date().toISOString().split('T')[0],
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });
                
                if (upsertError) {
                    console.error('Áµ±Ë®àÊõ¥Êñ∞„Ç®„É©„Éº:', upsertError);
                } else {
                    console.log('Áµ±Ë®àÊõ¥Êñ∞ÊàêÂäü');
                }
            } catch (error) {
                console.error('Áµ±Ë®àÊõ¥Êñ∞„Ç®„É©„Éº:', error);
            }
        }
        
        // Ë≥ºÂÖ•Â±•Ê≠¥„Çí„Éá„Éº„Çø„Éô„Éº„Çπ„Å´‰øùÂ≠ò
        async function savePurchaseToDatabase(itemId, itemName, itemCost, effects, statChanges) {
            if (useLocalMode || !supabase || !isAuthenticated) {
                console.log('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åæ„Åü„ÅØÊú™Ë™çË®ºÁä∂ÊÖã„ÅÆ„Åü„ÇÅ„ÄÅË≥ºÂÖ•Â±•Ê≠¥‰øùÂ≠ò„Çí„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }
            
            try {
                console.log('Ë≥ºÂÖ•Â±•Ê≠¥„Çí‰øùÂ≠òÈñãÂßã:', { itemId, itemName, itemCost, effects, statChanges });
                
                // purchase_history„ÉÜ„Éº„Éñ„É´„Å´‰øùÂ≠ò
                const { error } = await supabase
                    .from('purchase_history')
                    .insert({
                        user_id: currentUser.id,
                        item_id: itemId,
                        item_name: itemName,
                        item_cost: itemCost,
                        quantity: 1,
                        stats_effect: statChanges
                    });
                
                if (error) {
                    console.error('Ë≥ºÂÖ•Â±•Ê≠¥‰øùÂ≠ò„Ç®„É©„Éº:', error);
                } else {
                    console.log('Ë≥ºÂÖ•Â±•Ê≠¥‰øùÂ≠òÊàêÂäü');
                }
            } catch (error) {
                console.error('Ë≥ºÂÖ•Â±•Ê≠¥‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }
        
        // „Éë„Éº„ÉÜ„Ç£„ÉºÁ∑®Êàê„Çí„Éá„Éº„Çø„Éô„Éº„Çπ„Å´‰øùÂ≠ò
        async function savePartyToDatabase() {
            if (useLocalMode || !supabase || !isAuthenticated) {
                console.log('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åæ„Åü„ÅØÊú™Ë™çË®ºÁä∂ÊÖã„ÅÆ„Åü„ÇÅ„ÄÅ„Éë„Éº„ÉÜ„Ç£„ÉºÁ∑®Êàê‰øùÂ≠ò„Çí„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }
            
            try {
                console.log('„Éë„Éº„ÉÜ„Ç£„ÉºÁ∑®Êàê„Çí‰øùÂ≠òÈñãÂßã');
                
                // „Éë„Éº„ÉÜ„Ç£„Éº„Çπ„É≠„ÉÉ„Éà„ÇíJSONBÂΩ¢Âºè„Å´Â§âÊèõ
                const partySlots = gameState.party.map(char => ({
                    characterId: char.id,
                    name: char.name,
                    icon: char.icon
                }));
                
                // user_parties„ÉÜ„Éº„Éñ„É´„ÇíÊõ¥Êñ∞„Åæ„Åü„ÅØ‰ΩúÊàê
                const { error } = await supabase
                    .from('user_parties')
                    .upsert({
                        user_id: currentUser.id,
                        party_name: '„É°„Ç§„É≥„Éë„Éº„ÉÜ„Ç£„Éº',
                        party_slots: partySlots,
                        is_active: true,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id,party_name'
                    });
                
                if (error) {
                    console.error('„Éë„Éº„ÉÜ„Ç£„ÉºÁ∑®Êàê‰øùÂ≠ò„Ç®„É©„Éº:', error);
                } else {
                    console.log('„Éë„Éº„ÉÜ„Ç£„ÉºÁ∑®Êàê‰øùÂ≠òÊàêÂäü');
                }
            } catch (error) {
                console.error('„Éë„Éº„ÉÜ„Ç£„ÉºÁ∑®Êàê‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }
        
        // „Ç≠„É£„É©„ÇØ„Çø„ÉºÊâÄÊúâÊÉÖÂ†±„Çí„Éá„Éº„Çø„Éô„Éº„Çπ„Å´‰øùÂ≠ò
        async function saveCharacterToDatabase(character) {
            if (useLocalMode || !supabase || !isAuthenticated) {
                console.log('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åæ„Åü„ÅØÊú™Ë™çË®ºÁä∂ÊÖã„ÅÆ„Åü„ÇÅ„ÄÅ„Ç≠„É£„É©„ÇØ„Çø„ÉºÊâÄÊúâÊÉÖÂ†±‰øùÂ≠ò„Çí„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }
            
            try {
                console.log('„Ç≠„É£„É©„ÇØ„Çø„ÉºÊâÄÊúâÊÉÖÂ†±„Çí‰øùÂ≠òÈñãÂßã:', character);
                
                // user_characters„ÉÜ„Éº„Éñ„É´„Å´‰øùÂ≠ò
                const { error } = await supabase
                    .from('user_characters')
                    .upsert({
                        user_id: currentUser.id,
                        character_id: character.id,
                        level: 1,
                        experience: 0,
                        stats: character.baseStats,
                        last_used_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id,character_id'
                    });
                
                if (error) {
                    console.error('„Ç≠„É£„É©„ÇØ„Çø„ÉºÊâÄÊúâÊÉÖÂ†±‰øùÂ≠ò„Ç®„É©„Éº:', error);
                } else {
                    console.log('„Ç≠„É£„É©„ÇØ„Çø„ÉºÊâÄÊúâÊÉÖÂ†±‰øùÂ≠òÊàêÂäü');
                }
            } catch (error) {
                console.error('„Ç≠„É£„É©„ÇØ„Çø„ÉºÊâÄÊúâÊÉÖÂ†±‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }
        
        // „Ç≠„É£„É©„ÇØ„Çø„ÉºË©≥Á¥∞„ÇíË°®Á§∫
        async function showCharacterDetails(characterId) {
            const character = gameState.ownedCharacters.find(c => c.id === characterId);
            if (!character) {
                showToast('„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            console.log('„Ç≠„É£„É©„ÇØ„Çø„ÉºË©≥Á¥∞Ë°®Á§∫:', character);
            
            // Ë≥ºÂÖ•Â±•Ê≠¥„ÇíÂèñÂæóÔºà„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÔºâ
            const purchaseHistory = await loadPurchaseHistoryFromDatabase(characterId);
            
            // „Ç≠„É£„É©„ÇØ„Çø„ÉºË©≥Á¥∞„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
            const dialog = document.createElement('div');
            dialog.className = 'character-details-dialog';
            dialog.innerHTML = `
                <div class="character-details-content">
                    <div class="character-details-header">
                        <div class="character-details-icon">
                            <img src="10_Á§æÁïú„Ç¢„Ç§„Ç≥„É≥/${character.icon}" alt="${character.name}" loading="lazy"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div style="width: 120px; height: 120px; background: #ddd; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 48px; color: #666;">
                                ${character.name.charAt(0)}
                            </div>
                        </div>
                        <div class="character-details-info">
                            <h2>${character.name}</h2>
                            <p class="character-description">${character.description || 'Ë™¨Êòé„Å™„Åó'}</p>
                        </div>
                    </div>
                    
                    <div class="character-details-stats">
                        <h3>„Çπ„ÉÜ„Éº„Çø„Çπ</h3>
                        <div class="stat-grid">
                            <div class="stat-item">
                                <span class="stat-icon">üò§</span>
                                <span class="stat-label">„Çπ„Éà„É¨„ÇπËÄêÊÄß</span>
                                <span class="stat-value">${gameState.stats.stress || 0}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">üß†</span>
                                <span class="stat-label">Áü•Ë≠ò</span>
                                <span class="stat-value">${gameState.stats.knowledge || 0}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">üí™</span>
                                <span class="stat-label">‰ΩìÂäõ</span>
                                <span class="stat-value">${gameState.stats.physical || 0}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">üí¨</span>
                                <span class="stat-label">„Ç≥„Éü„É•Âäõ</span>
                                <span class="stat-value">${gameState.stats.communication || 0}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="character-details-purchases">
                        <h3>Ë≥ºÂÖ•„Åó„Åü„Ç¢„Ç§„ÉÜ„É† (${purchaseHistory.length}‰ª∂)</h3>
                        ${purchaseHistory.length > 0 ? `
                            <div class="purchase-list">
                                ${purchaseHistory.map(purchase => `
                                    <div class="purchase-item">
                                        <span class="purchase-icon">${purchase.icon || 'üíä'}</span>
                                        <span class="purchase-name">${purchase.item_name}</span>
                                        <span class="purchase-date">${new Date(purchase.purchased_at).toLocaleDateString('ja-JP')}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p>„Åæ„Å†Ë≥ºÂÖ•„Åó„Åü„Ç¢„Ç§„ÉÜ„É†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>'}
                    </div>
                    
                    <button class="btn-primary" onclick="this.parentElement.parentElement.remove();">Èñâ„Åò„Çã</button>
                </div>
            `;
            document.body.appendChild(dialog);
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            setTimeout(() => {
                dialog.style.opacity = '1';
                dialog.style.transform = 'scale(1)';
            }, 10);
        }
        
        // Ë≥ºÂÖ•Â±•Ê≠¥„Çí„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâË™≠„ÅøËæº„Åø
        async function loadPurchaseHistoryFromDatabase(characterId) {
            if (useLocalMode || !supabase || !isAuthenticated) {
                return [];
            }
            
            try {
                // purchase_history„ÉÜ„Éº„Éñ„É´„Åã„ÇâË©≤ÂΩì„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆË≥ºÂÖ•Â±•Ê≠¥„ÇíÂèñÂæó
                const { data, error } = await supabase
                    .from('purchase_history')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('purchased_at', { ascending: false })
                    .limit(10);
                
                if (error) {
                    console.error('Ë≥ºÂÖ•Â±•Ê≠¥Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    return [];
                }
                
                // „Ç¢„Ç§„ÉÜ„É†„Ç¢„Ç§„Ç≥„É≥„ÇíËøΩÂä†
                return data.map(item => {
                    const shopItem = SHOP_ITEMS.find(i => i.id === item.item_id);
                    return {
                        ...item,
                        icon: shopItem ? shopItem.icon : 'üíä'
                    };
                });
            } catch (error) {
                console.error('Ë≥ºÂÖ•Â±•Ê≠¥Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                return [];
            }
        }
        
        // Ë≥ºÂÖ•ÊàêÂäü„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
        function showPurchaseSuccessDialog(item, statChanges) {
            const dialog = document.createElement('div');
            dialog.className = 'purchase-success-dialog';
            dialog.innerHTML = `
                <div class="purchase-success-content">
                    <div class="purchase-success-icon">${item.icon}</div>
                    <h2>${item.name}„ÇíË≥ºÂÖ•„Åó„Åæ„Åó„ÅüÔºÅ</h2>
                    <div class="stat-changes">
                        ${Object.keys(statChanges).map(stat => {
                            const statNames = { 
                                stress: '„Çπ„Éà„É¨„ÇπËÄêÊÄß', 
                                knowledge: 'Áü•Ë≠ò', 
                                physical: '‰ΩìÂäõ', 
                                communication: '„Ç≥„Éü„É•Âäõ' 
                            };
                            const change = statChanges[stat];
                            const icon = stat === 'stress' ? 'üò§' : stat === 'knowledge' ? 'üß†' : stat === 'physical' ? 'üí™' : 'üí¨';
                            return `
                                <div class="stat-change-item ${change > 0 ? 'positive' : 'negative'}">
                                    <span class="stat-icon">${icon}</span>
                                    <span class="stat-name">${statNames[stat]}</span>
                                    <span class="stat-change">${change > 0 ? '+' : ''}${change}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <button class="btn-primary" onclick="this.parentElement.parentElement.remove(); animateStatBars();">Èñâ„Åò„Çã</button>
                </div>
            `;
            document.body.appendChild(dialog);
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            setTimeout(() => {
                dialog.style.opacity = '1';
                dialog.style.transform = 'scale(1)';
            }, 10);
        }
        
        // „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº„Çí„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        function animateStatBars() {
            const statElements = document.querySelectorAll('.stat-bar');
            statElements.forEach(el => {
                el.style.transition = 'width 0.5s ease';
                // „Éà„É™„Ç¨„ÉºÂÜçÊèèÁîª
                const width = el.style.width;
                el.style.width = '0';
                setTimeout(() => {
                    el.style.width = width;
                }, 10);
            });
        }
        
        // Supabase„Åã„Çâ„Ç≤„Éº„É†„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
        async function loadGameDataFromSupabase() {
            if (!isAuthenticated || !currentUser) {
                console.log('Êú™Ë™çË®ºÁä∂ÊÖã„ÅÆ„Åü„ÇÅSupabaseË™≠„ÅøËæº„Åø„Çí„Çπ„Ç≠„ÉÉ„Éó');
                return null;
            }
            
            try {
                const { data, error } = await supabase
                    .from('game_saves')
                    .select('save_data, version, updated_at')
                    .eq('user_id', currentUser.id)
                    .eq('game_name', 'shachipoke2')
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        console.log('Supabase„Å´„Çª„Éº„Éñ„Éá„Éº„Çø„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì');
                        return null;
                    }
                    console.error('SupabaseË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    showToast('„ÇØ„É©„Ç¶„ÉâË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    return null;
                }
                
                console.log('SupabaseË™≠„ÅøËæº„ÅøÊàêÂäü:', data);
                showToast('„ÇØ„É©„Ç¶„Éâ„Åã„ÇâË™≠„ÅøËæº„Åø„Åæ„Åó„Åü', 'success');
                return data.save_data;
            } catch (error) {
                console.error('SupabaseË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                showToast('„ÇØ„É©„Ç¶„ÉâË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                return null;
            }
        }
        
        // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíSupabase„Å´ÁßªË°å
        async function migrateLocalDataToSupabase() {
            if (!isAuthenticated || !supabase || !currentUser) {
                console.log('Ë™çË®º„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„Éá„Éº„ÇøÁßªË°å„Çí„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }
            
            // „Éó„É≠„Éï„Ç£„Éº„É´„ÇíÁ¢∫ÂÆü„Å´‰ΩúÊàê
            await ensureUserProfile(currentUser);
            
            const localData = localStorage.getItem('shachipoke2_save');
            if (!localData) {
                console.log('„É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅÁßªË°å„Çí„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }
            
            try {
                const parsedData = JSON.parse(localData);
                
                // „Åæ„ÅöÊó¢Â≠ò„ÅÆ„Éá„Éº„Çø„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                const { data: existingData, error: checkError } = await supabase
                    .from('game_saves')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('game_name', 'shachipoke2')
                    .single();
                
                if (checkError && checkError.code !== 'PGRST116') {
                    console.error('Êó¢Â≠ò„Éá„Éº„Çø„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', checkError);
                    showToast('„Éá„Éº„ÇøÁßªË°å„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    return;
                }
                
                if (existingData) {
                    console.log('Êó¢Â≠ò„ÅÆ„Éá„Éº„Çø„ÅåÂ≠òÂú®„Åó„Åæ„Åô„ÄÇÁßªË°å„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ');
                    return;
                }
                
                // Êñ∞Ë¶è„Éá„Éº„Çø„ÇíÊåøÂÖ•
                const { data, error } = await supabase
                    .from('game_saves')
                    .insert({
                        user_id: currentUser.id,
                        game_name: 'shachipoke2',
                        save_data: parsedData,
                        version: '1.0.0',
                        updated_at: new Date().toISOString()
                    });
                
                if (error) {
                    console.error('„Éá„Éº„ÇøÁßªË°å„Ç®„É©„Éº:', error);
                    showToast('„Éá„Éº„ÇøÁßªË°å„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                } else {
                    console.log('„É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíSupabase„Å´ÁßªË°å„Åó„Åæ„Åó„Åü:', data);
                    showToast('„Éá„Éº„Çø„Çí„ÇØ„É©„Ç¶„Éâ„Å´ÁßªË°å„Åó„Åæ„Åó„Åü', 'success');
                }
            } catch (error) {
                console.error('„Éá„Éº„ÇøÁßªË°å„Ç®„É©„Éº:', error);
                showToast('„Éá„Éº„ÇøÁßªË°å„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        // SupabaseÊé•Á∂ö„ÉÜ„Çπ„ÉàÈñ¢Êï∞
        async function testSupabaseConnection() {
            console.log('=== SupabaseÊé•Á∂ö„ÉÜ„Çπ„ÉàÈñãÂßã ===');
            console.log('useLocalMode:', useLocalMode);
            console.log('supabase:', supabase);
            
            if (!supabase) {
                console.error('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Åånull„Åß„Åô');
                return false;
            }
            
            try {
                // Âü∫Êú¨ÁöÑ„Å™Êé•Á∂ö„ÉÜ„Çπ„Éà
                console.log('1. Âü∫Êú¨ÁöÑ„Å™Êé•Á∂ö„ÉÜ„Çπ„Éà...');
                const { data, error } = await supabase.from('profiles').select('count').limit(1);
                
                if (error) {
                    console.error('Êé•Á∂ö„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', error);
                    return false;
                }
                
                console.log('‚úÖ Âü∫Êú¨ÁöÑ„Å™Êé•Á∂ö„ÉÜ„Çπ„ÉàÊàêÂäü:', data);
                
                // Ë™çË®º„ÉÜ„Çπ„Éà
                console.log('2. Ë™çË®º„ÉÜ„Çπ„Éà...');
                const { data: session, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    console.error('Ë™çË®º„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', sessionError);
                } else {
                    console.log('‚úÖ Ë™çË®º„ÉÜ„Çπ„ÉàÊàêÂäü:', session);
                }
                
                // RLSË®≠ÂÆö„ÅÆÁ¢∫Ë™ç
                console.log('3. RLSË®≠ÂÆö„ÅÆÁ¢∫Ë™ç...');
                await checkAndFixRLS();
                
                return true;
                
            } catch (error) {
                console.error('SupabaseÊé•Á∂ö„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', error);
                return false;
            }
        }
        
        // RLSË®≠ÂÆö„ÅÆÁ¢∫Ë™ç„Å®‰øÆÊ≠£
        async function checkAndFixRLS() {
            if (useLocalMode || !supabase) {
                console.log('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åæ„Åü„ÅØSupabaseÊé•Á∂ö„Å™„Åó„ÅÆ„Åü„ÇÅ„ÄÅRLSÁ¢∫Ë™ç„Çí„Çπ„Ç≠„ÉÉ„Éó');
                showToast('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„ÅßÂãï‰Ωú‰∏≠„Åß„Åô', 'info');
                return;
            }
            
            try {
                console.log('=== RLSË®≠ÂÆö„ÅÆÁ¢∫Ë™çÈñãÂßã ===');
                showToast('RLSË®≠ÂÆö„ÇíÁ¢∫Ë™ç‰∏≠...', 'info');
                
                // RLSÁä∂Ê≥Å„ÇíÁ¢∫Ë™çÔºà„Éá„Éº„Çø„Ç¢„ÇØ„Çª„Çπ„Åß„ÉÜ„Çπ„ÉàÔºâ
                const { data: profiles, error: profilesError } = await supabase
                    .from('profiles')
                    .select('id')
                    .limit(1);
                
                console.log('RLS„ÉÅ„Çß„ÉÉ„ÇØÁµêÊûú:', { profiles, profilesError });
                
                // RLS„ÅåÊúâÂäπ„Å™Â†¥Âêà„ÄÅË™çË®ºÊ∏à„Åø„É¶„Éº„Ç∂„Éº„ÅØËá™ÂàÜ„ÅÆ„Éá„Éº„Çø„ÅÆ„Åø„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ
                // RLS„ÅåÁÑ°Âäπ„Å™Â†¥Âêà„ÄÅË™çË®ºÊ∏à„Åø„Åß„Å™„ÅÑ„É¶„Éº„Ç∂„Éº„Åß„ÇÇ„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ
                if (profilesError) {
                    console.log('‚úÖ RLS„ÅåÊúâÂäπ„Å´„Å™„Å£„Å¶„ÅÑ„Åæ„ÅôÔºà„Ç®„É©„Éº:', profilesError.code, ')');
                    showToast('‚úÖ RLS„ÅåÊúâÂäπ„Å´„Å™„Å£„Å¶„ÅÑ„Åæ„Åô', 'success');
                } else if (isAuthenticated) {
                    // Ë™çË®ºÊ∏à„Åø„É¶„Éº„Ç∂„Éº„Åß„Éá„Éº„Çø„ÅåÂèñÂæó„Åß„Åç„ÇãÂ†¥Âêà„ÄÅRLS„ÅØÊ≠£Â∏∏„Å´Ê©üËÉΩ„Åó„Å¶„ÅÑ„Çã
                    console.log('‚úÖ RLS„ÅåÊ≠£Â∏∏„Å´Ê©üËÉΩ„Åó„Å¶„ÅÑ„Åæ„Åô');
                    showToast('‚úÖ RLS„ÅåÊ≠£Â∏∏„Å´Ê©üËÉΩ„Åó„Å¶„ÅÑ„Åæ„Åô', 'success');
                } else {
                    // Êú™Ë™çË®º„Åß„Éá„Éº„Çø„ÅåÂèñÂæó„Åß„Åç„ÅüÂ†¥Âêà„ÄÅRLS„ÅåÁÑ°Âäπ„ÅÆÂèØËÉΩÊÄß
                    console.log('‚ùå RLS„ÅåÁÑ°Âäπ„Å´„Å™„Å£„Å¶„ÅÑ„Åæ„ÅôÔºàÊú™Ë™çË®º„Åß„ÇÇ„Éá„Éº„Çø„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩÔºâ');
                    showToast('‚ùå RLS„ÅåÁÑ°Âäπ„Å´„Å™„Å£„Å¶„ÅÑ„Åæ„Åô', 'error');
                    showRLSSetupInstructions(true);
                }
                
            } catch (error) {
                console.error('RLSÁ¢∫Ë™ç„Ç®„É©„Éº:', error);
                showToast('RLSÁ¢∫Ë™ç‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        // RLSË®≠ÂÆöÊâãÈ†Ü„ÇíË°®Á§∫Ôºà„Ç™„Éó„Ç∑„Éß„É≥„Åß„ÉÄ„Ç§„Ç¢„É≠„Ç∞Ë°®Á§∫Ôºâ
        function showRLSSetupInstructions(showDialog = false) {
            const instructions = `
RLSË®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÊâãÈ†Ü„ÅßSupabase SQL Editor„ÅßÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

1. Supabase„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ ‚Üí SQL Editor
2. enable-rls-secure.sql „ÅÆÂÜÖÂÆπ„Çí„Ç≥„Éî„Éº&„Éö„Éº„Çπ„Éà
3. "Run"„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ

„Åì„Çå„Å´„Çà„Çä„ÄÅ„Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÅåÂº∑Âåñ„Åï„Çå„Åæ„Åô„ÄÇ
            `;
            
            console.log(instructions);
            
            // „Ç™„Éó„Ç∑„Éß„É≥„Åß„É¶„Éº„Ç∂„Éº„Å´ÈÄöÁü•Ôºà„Éá„Éï„Ç©„É´„Éà„Åß„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºâ
            if (showDialog && confirm('„Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆ„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ\nË®≠ÂÆöÊâãÈ†Ü„ÇíË°®Á§∫„Åó„Åæ„Åô„ÅãÔºü')) {
                alert(instructions);
            }
        }
        
        // „Ç≤„Éº„É†„Éá„Éº„Çø„ÅÆÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
        function validateGameData(data) {
            try {
                // ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„ÅÆÂ≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ
                if (!data.selectedCharacter || typeof data.shachi !== 'number' || typeof data.level !== 'number' || !data.stats) {
                    console.error('ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
                    return false;
                }
                
                // „Ç∑„É£„ÉÅ„ÅÆÂÄ§„Åå0‰ª•‰∏ä„Åã„Å§ÂêàÁêÜÁöÑ„Å™ÁØÑÂõ≤ÂÜÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (data.shachi < 0 || data.shachi > 1000000) {
                    console.error('„Ç∑„É£„ÉÅ„ÅÆÂÄ§„ÅåÁØÑÂõ≤Â§ñ„Åß„Åô:', data.shachi);
                    return false;
                }
                
                // „É¨„Éô„É´„ÅÆÂÄ§„Åå1‰ª•‰∏ä„Åã„Å§ÂêàÁêÜÁöÑ„Å™ÁØÑÂõ≤ÂÜÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (data.level < 1 || data.level > 1000) {
                    console.error('„É¨„Éô„É´„ÅÆÂÄ§„ÅåÁØÑÂõ≤Â§ñ„Åß„Åô:', data.level);
                    return false;
                }
                
                // „Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÊßãÈÄ†„ÉÅ„Çß„ÉÉ„ÇØ
                const requiredStats = ['stress', 'knowledge', 'physical', 'communication'];
                for (const stat of requiredStats) {
                    if (typeof data.stats[stat] !== 'number' || data.stats[stat] < 0 || data.stats[stat] > 200) {
                        console.error(`„Çπ„ÉÜ„Éº„Çø„Çπ ${stat} „ÅÆÂÄ§„ÅåÁØÑÂõ≤Â§ñ„Åß„Åô:`, data.stats[stat]);
                        return false;
                    }
                }
                
                // ÊâÄÊúâ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÈÖçÂàó„ÉÅ„Çß„ÉÉ„ÇØ
                if (!Array.isArray(data.ownedCharacters)) {
                    console.error('ownedCharacters„ÅØÈÖçÂàó„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô');
                    return false;
                }
                
                // Ë≥ºÂÖ•„Ç¢„Ç§„ÉÜ„É†„ÅÆÈÖçÂàó„ÉÅ„Çß„ÉÉ„ÇØ
                if (!Array.isArray(data.purchasedItems)) {
                    console.error('purchasedItems„ÅØÈÖçÂàó„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô');
                    return false;
                }
                
                // ÈÖçÂàó„ÅÆÈï∑„Åï„ÅåÂêàÁêÜÁöÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (data.ownedCharacters.length > 20 || data.purchasedItems.length > 100) {
                    console.error('ÈÖçÂàó„ÅÆÈï∑„Åï„ÅåÁï∞Â∏∏„Åß„Åô');
                    return false;
                }
                
                console.log('‚úÖ „Ç≤„Éº„É†„Éá„Éº„Çø„ÅÆÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØÊàêÂäü');
                return true;
            } catch (error) {
                console.error('„Éá„Éº„ÇøÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', error);
                return false;
            }
        }
        
        // „Çª„Ç≠„É•„É™„ÉÜ„Ç£Áõ£ÊüªÊ©üËÉΩ
        async function performSecurityAudit() {
            if (useLocalMode || !supabase) {
                console.log('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åæ„Åü„ÅØSupabaseÊé•Á∂ö„Å™„Åó„ÅÆ„Åü„ÇÅ„ÄÅ„Çª„Ç≠„É•„É™„ÉÜ„Ç£Áõ£Êüª„Çí„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }
            
            try {
                console.log('=== „Çª„Ç≠„É•„É™„ÉÜ„Ç£Áõ£ÊüªÈñãÂßã ===');
                
                const auditResults = {
                    rlsEnabled: false,
                    dataAccess: false,
                    authentication: false,
                    dataIntegrity: false
                };
                
                // 1. RLSÊúâÂäπÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
                console.log('1. RLSÊúâÂäπÊÄß„ÉÅ„Çß„ÉÉ„ÇØ...');
                const { data: profiles, error: profilesError } = await supabase
                    .from('profiles')
                    .select('id')
                    .limit(1);
                
                // RLS„ÅÆÂà§ÂÆö„ÇíÊîπÂñÑ: „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„Å®Ë©≥Á¥∞„É≠„Ç∞
                if (profilesError) {
                    // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„ÅüÂ†¥Âêà„ÄÅRLS„ÅåÊúâÂäπ„Å´„Å™„Å£„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„ÅåÈ´ò„ÅÑ
                    if (profilesError.code === 'PGRST301' || profilesError.code === '42883') {
                        auditResults.rlsEnabled = true;
                        console.log('‚úÖ RLS„ÅåÊúâÂäπ„Å´„Å™„Å£„Å¶„ÅÑ„Åæ„Åô');
                    } else {
                        console.log('‚ö†Ô∏è ‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº:', profilesError.code, profilesError.message);
                        // RLS„ÅØÊúâÂäπ„Å†„Åå„ÄÅ‰ªñ„ÅÆÁêÜÁî±„Åß„Ç®„É©„Éº
                        auditResults.rlsEnabled = true;
                    }
                } else {
                    // „Ç®„É©„Éº„Åå„Å™„Åè„ÄÅ„Éá„Éº„Çø„ÅåÂèñÂæó„Åß„Åç„ÅüÂ†¥Âêà
                    if (isAuthenticated && currentUser && profiles && profiles.length > 0) {
                        // Ë™çË®ºÊ∏à„Åø„Åß„Éá„Éº„Çø„ÅåÂèñÂæó„Åß„Åç„Åü = RLS„ÅØÊ≠£Â∏∏„Å´Ê©üËÉΩ„Åó„Å¶„ÅÑ„Çã
                        auditResults.rlsEnabled = true;
                        console.log('‚úÖ RLS„ÅåÊ≠£Â∏∏„Å´Ê©üËÉΩ„Åó„Å¶„ÅÑ„Åæ„ÅôÔºàËá™ÂàÜ„ÅÆ„Éá„Éº„Çø„Å´„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩÔºâ');
                    } else if (!isAuthenticated) {
                        // Êú™Ë™çË®º„Åß„Éá„Éº„Çø„ÅåÂèñÂæó„Åß„Åç„ÅüÂ†¥Âêà„ÄÅRLS„ÅåÁÑ°Âäπ„ÅÆÂèØËÉΩÊÄß
                        auditResults.rlsEnabled = false;
                        console.log('‚ùå RLS„ÅåÁÑ°Âäπ„Å´„Å™„Å£„Å¶„ÅÑ„Åæ„ÅôÔºàÊú™Ë™çË®º„Åß„ÇÇ„Éá„Éº„Çø„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩÔºâ');
                    } else {
                        // „Åù„ÅÆ‰ªñ„ÅÆ„Ç±„Éº„Çπ
                        auditResults.rlsEnabled = true;
                        console.log('‚úÖ RLS„ÅØÊúâÂäπ„Åß„Åô„Åå„ÄÅ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    }
                }
                
                // 2. „Éá„Éº„Çø„Ç¢„ÇØ„Çª„Çπ„ÉÅ„Çß„ÉÉ„ÇØÔºàË™çË®ºÊ∏à„Åø„É¶„Éº„Ç∂„Éº„ÅÆ„ÅøÔºâ
                if (isAuthenticated) {
                    console.log('2. „Éá„Éº„Çø„Ç¢„ÇØ„Çª„Çπ„ÉÜ„Çπ„Éà...');
                    const { data: userData, error: userError } = await supabase
                        .from('profiles')
                        .select('id, email')
                        .eq('id', currentUser.id)
                        .single();
                    
                    if (!userError && userData) {
                        auditResults.dataAccess = true;
                        console.log('‚úÖ Ëá™ÂàÜ„ÅÆ„Éá„Éº„Çø„Å´„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ');
                    } else {
                        console.log('‚ùå Ëá™ÂàÜ„ÅÆ„Éá„Éº„Çø„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì');
                    }
                }
                
                // 3. Ë™çË®ºÁä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ
                console.log('3. Ë™çË®ºÁä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ...');
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    auditResults.authentication = true;
                    console.log('‚úÖ Ë™çË®ºÁä∂ÊÖã„ÅåÊ≠£Â∏∏');
                } else {
                    console.log('‚ùå Ë™çË®ºÁä∂ÊÖã„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô');
                }
                
                // 4. „Éá„Éº„ÇøÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
                console.log('4. „Éá„Éº„ÇøÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØ...');
                if (validateGameData(gameState)) {
                    auditResults.dataIntegrity = true;
                    console.log('‚úÖ „Ç≤„Éº„É†„Éá„Éº„Çø„ÅÆÊï¥ÂêàÊÄß„ÅåÊ≠£Â∏∏');
                } else {
                    console.log('‚ùå „Ç≤„Éº„É†„Éá„Éº„Çø„ÅÆÊï¥ÂêàÊÄß„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô');
                }
                
                // Áõ£ÊüªÁµêÊûú„ÅÆË°®Á§∫
                console.log('=== „Çª„Ç≠„É•„É™„ÉÜ„Ç£Áõ£ÊüªÁµêÊûú ===');
                console.log('RLSÊúâÂäπ:', auditResults.rlsEnabled ? '‚úÖ' : '‚ùå');
                console.log('„Éá„Éº„Çø„Ç¢„ÇØ„Çª„Çπ:', auditResults.dataAccess ? '‚úÖ' : '‚ùå');
                console.log('Ë™çË®ºÁä∂ÊÖã:', auditResults.authentication ? '‚úÖ' : '‚ùå');
                console.log('„Éá„Éº„ÇøÊï¥ÂêàÊÄß:', auditResults.dataIntegrity ? '‚úÖ' : '‚ùå');
                
                // „Çª„Ç≠„É•„É™„ÉÜ„Ç£„Çπ„Ç≥„Ç¢„ÅÆË®àÁÆó
                const securityScore = Object.values(auditResults).filter(Boolean).length;
                const totalChecks = Object.keys(auditResults).length;
                const percentage = Math.round((securityScore / totalChecks) * 100);
                
                console.log(`„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Çπ„Ç≥„Ç¢: ${securityScore}/${totalChecks} (${percentage}%)`);
                
                if (percentage < 100) {
                    showToast(`„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Çπ„Ç≥„Ç¢: ${percentage}% - ÊîπÂñÑ„ÅåÂøÖË¶Å„Åß„Åô`, 'warning');
                } else {
                    showToast(`„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Çπ„Ç≥„Ç¢: ${percentage}% - ËâØÂ•Ω„Åß„Åô`, 'success');
                }
                
            } catch (error) {
                console.error('„Çª„Ç≠„É•„É™„ÉÜ„Ç£Áõ£Êüª„Ç®„É©„Éº:', error);
            }
        }
        
        // „É¶„Éº„Ç∂„Éº„Éó„É≠„Éï„Ç£„Éº„É´„ÇíËá™Âãï‰ΩúÊàê
        async function ensureUserProfile(user) {
            if (!supabase || !user) return;
            
            try {
                // Êó¢Â≠ò„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const { data: existingProfile, error: checkError } = await supabase
                    .from('profiles')
                    .select('id')
                    .eq('id', user.id)
                    .single();
                
                if (checkError && checkError.code !== 'PGRST116') {
                    console.error('„Éó„É≠„Éï„Ç£„Éº„É´„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', checkError);
                    return false;
                }
                
                if (existingProfile) {
                    console.log('„Éó„É≠„Éï„Ç£„Éº„É´„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô');
                    return true;
                }
                
                // Êñ∞„Åó„ÅÑ„Éó„É≠„Éï„Ç£„Éº„É´„Çí‰ΩúÊàê
                const { data, error } = await supabase
                    .from('profiles')
                    .insert({
                        id: user.id,
                        email: user.email,
                        display_name: user.user_metadata?.full_name || user.email,
                        avatar_url: user.user_metadata?.avatar_url || null
                    });
                
                if (error) {
                    console.error('„Éó„É≠„Éï„Ç£„Éº„É´‰ΩúÊàê„Ç®„É©„Éº:', error);
                    return false;
                }
                
                console.log('‚úÖ „Éó„É≠„Éï„Ç£„Éº„É´„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü:', data);
                return true;
                
            } catch (error) {
                console.error('„Éó„É≠„Éï„Ç£„Éº„É´‰ΩúÊàê„Ç®„É©„Éº:', error);
                return false;
            }
        }
        
        // Ë™çË®ºÁä∂ÊÖãË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateAuthStatus() {
            const authInfo = document.getElementById('auth-info');
            const loginPrompt = document.getElementById('login-prompt');
            const userEmail = document.getElementById('user-email');
            
            // „É°„Ç§„É≥ÁîªÈù¢„ÅÆË™çË®ºÁä∂ÊÖãË°®Á§∫
            const mainAuthInfo = document.getElementById('main-auth-info');
            const mainLoginPrompt = document.getElementById('main-login-prompt');
            const mainUserEmail = document.getElementById('main-user-email');
            
            console.log('updateAuthStatus called - isAuthenticated:', isAuthenticated, 'currentUser:', currentUser);
            
            if (isAuthenticated && currentUser) {
                console.log('Ë™çË®ºÊ∏à„ÅøÁä∂ÊÖã„ÇíË°®Á§∫');
                // „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏ÊäûÁîªÈù¢
                if (authInfo) authInfo.style.display = 'block';
                if (loginPrompt) loginPrompt.style.display = 'none';
                if (userEmail) userEmail.textContent = currentUser.email;
                
                // „É°„Ç§„É≥ÁîªÈù¢
                if (mainAuthInfo) mainAuthInfo.style.display = 'block';
                if (mainLoginPrompt) mainLoginPrompt.style.display = 'none';
                if (mainUserEmail) mainUserEmail.textContent = currentUser.email;
            } else {
                console.log('Êú™Ë™çË®ºÁä∂ÊÖã„ÇíË°®Á§∫');
                // „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏ÊäûÁîªÈù¢
                if (authInfo) authInfo.style.display = 'none';
                if (loginPrompt) loginPrompt.style.display = 'block';
                
                // „É°„Ç§„É≥ÁîªÈù¢
                if (mainAuthInfo) mainAuthInfo.style.display = 'none';
                if (mainLoginPrompt) mainLoginPrompt.style.display = 'block';
            }
            
            // SupabaseÊé•Á∂ö„Ç®„É©„Éº„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ËøΩÂä†
            if (!supabase || useLocalMode) {
                const errorMsg = document.createElement('p');
                errorMsg.style.color = '#f44336';
                errorMsg.style.fontSize = '12px';
                errorMsg.textContent = '‚Äª „ÇØ„É©„Ç¶„ÉâÊé•Á∂ö„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ„É≠„Éº„Ç´„É´‰øùÂ≠ò„ÅÆ„ÅøÂà©Áî®ÂèØËÉΩ„Åß„Åô„ÄÇ';
                if (loginPrompt && !loginPrompt.querySelector('p[style*="color: #f44336"]')) {
                    loginPrompt.appendChild(errorMsg);
                }
            }
        }
        
        // „É°„É¢„É™„É™„Éº„ÇØÈò≤Ê≠¢: „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆÁÆ°ÁêÜ
        const eventListeners = [];
        
        function addEventListenerWithCleanup(element, event, handler) {
            element.addEventListener(event, handler);
            eventListeners.push({ element, event, handler });
        }
        
        function cleanup() {
            eventListeners.forEach(({ element, event, handler }) => {
                element.removeEventListener(event, handler);
            });
            eventListeners.length = 0;
        }
        
        // „Ç≤„Éº„É†ÂàùÊúüÂåñ
        async function init() {
            console.log('„Ç≤„Éº„É†ÂàùÊúüÂåñÈñãÂßã');
            
            // ‰ª•Ââç„ÅÆ„É™„Çπ„Éä„Éº„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            cleanup();
            
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢„ÇíÈùûË°®Á§∫
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
            }
            
            // Ë™çË®ºÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            await checkAuthStatus();
            
            // SupabaseÊé•Á∂ö„ÉÜ„Çπ„Éà„ÇíÂÆüË°å
            await testSupabaseConnection();
            
            // Ë™çË®ºÁä∂ÊÖãË°®Á§∫„ÇíÊõ¥Êñ∞
            updateAuthStatus();
            
            // „Ç≤„Éº„É†„Éá„Éº„Çø„Çí„É≠„Éº„Éâ
            await loadGameData();
            
            // Êó•Êõø„Çè„Çä„ÉÅ„Çß„ÉÉ„ÇØ
            checkDailyReset();
            
            // Êó¢„Å´ÈÅîÊàêÊù°‰ª∂„ÇíÊ∫Ä„Åü„Åó„Å¶„ÅÑ„Çã„Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºà„Çµ„Ç§„É¨„É≥„Éà„É¢„Éº„ÉâÔºâ
            await checkAchievements(true);
            
            // „Ç≠„É£„É©„ÇØ„Çø„Éº„Ç∞„É™„ÉÉ„Éâ„Çí‰ΩúÊàê
            createCharacterGrid();
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆöÔºà„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂØæÂøúÔºâ
            const confirmBtn = document.getElementById('confirm-character');
            if (confirmBtn) {
                addEventListenerWithCleanup(confirmBtn, 'click', confirmCharacter);
            }
            
            // Ë™çË®ºÁä∂ÊÖã„Å´Âøú„Åò„Å¶ÁîªÈù¢„ÇíË°®Á§∫
            if (useLocalMode) {
                console.log('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åß„Ç≤„Éº„É†ÈñãÂßã');
                if (gameState.selectedCharacter) {
                    showScreen('main');
                    updateMainScreen();
                } else {
                    showScreen('character-selection');
                }
            } else if (isAuthenticated) {
                console.log('Ë™çË®ºÊ∏à„Åø„É¶„Éº„Ç∂„Éº„Åß„Ç≤„Éº„É†ÈñãÂßã');
                if (gameState.selectedCharacter) {
                    showScreen('main');
                    updateMainScreen();
                } else {
                    showScreen('character-selection');
                }
            } else {
                console.log('Êú™Ë™çË®ºÁä∂ÊÖã - Ë™çË®º„ÅåÂøÖË¶Å');
                showScreen('login-required');
            }
            
            console.log('„Ç≤„Éº„É†ÂàùÊúüÂåñÂÆå‰∫Ü');
        }

        // „Éö„Éº„Ç∏ÈÅ∑ÁßªÊôÇ„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        window.addEventListener('beforeunload', function() {
            cleanup();
        });
        
        // „Ç≠„Éº„Éú„Éº„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ÂØæÂøú
        document.addEventListener('keydown', function(e) {
            // Tab„Ç≠„Éº„Åß„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ÁßªÂãï
            if (e.key === 'Tab') {
                document.body.classList.add('keyboard-navigation');
            }
            
            // Esc„Ç≠„Éº„Åß„Éï„Ç©„Éº„Ç´„Çπ„Çí„ÇØ„É™„Ç¢
            if (e.key === 'Escape') {
                document.activeElement.blur();
            }
            
            // Enter„Ç≠„Éº„Åß„Éú„Çø„É≥„Ç¢„ÇØ„ÉÜ„Ç£„Éô„Éº„Ç∑„Éß„É≥
            if (e.key === 'Enter' && document.activeElement.classList.contains('nav-btn')) {
                e.preventDefault();
                document.activeElement.click();
            }
        });
        
        // „Éû„Ç¶„Çπ‰ΩøÁî®ÊôÇ„Å´„Ç≠„Éº„Éú„Éº„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„ÇØ„É©„Çπ„ÇíÂâäÈô§
        document.addEventListener('mousedown', function() {
            document.body.classList.remove('keyboard-navigation');
        });
        
        // „Ç≠„Éº„Éú„Éº„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥Áî®„ÅÆ„Çπ„Çø„Ç§„É´
        const style = document.createElement('style');
        style.textContent = `
            .keyboard-navigation *:focus {
                outline: 3px solid #007bff !important;
                outline-offset: 2px;
            }
            
            .keyboard-navigation button:focus,
            .keyboard-navigation .nav-btn:focus {
                transform: scale(1.05);
            }
        `;
        document.head.appendChild(style);
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
            try {
                init();
            } catch (error) {
                console.error('ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                document.body.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: white; margin: 20px; border-radius: 10px;">
                        <h1>ÂàùÊúüÂåñ„Ç®„É©„Éº</h1>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">ÂÜçË™≠„ÅøËæº„Åø</button>
                    </div>
                `;
            }
        });
    </script>
    
    <!-- „Ç∞„É≠„Éº„Éê„É´„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥Ôºà„Åô„Åπ„Å¶„ÅÆÁîªÈù¢„ÅßÂÖ±ÈÄöÔºâ -->
    <div class="main-navigation" id="global-navigation">
        <button class="nav-btn" onclick="showScreen('main')">
            <span class="nav-icon">üè†</span>
            <span>„Éõ„Éº„É†</span>
        </button>
        <button class="nav-btn" onclick="showScreen('events')">
            <span class="nav-icon">üìÖ</span>
            <span>„Ç§„Éô„É≥„Éà</span>
        </button>
        <button class="nav-btn" onclick="showScreen('shop')">
            <span class="nav-icon">üõí</span>
            <span>„Ç∑„Éß„ÉÉ„Éó</span>
        </button>
        <button class="nav-btn" onclick="showScreen('formation')">
            <span class="nav-icon">üë•</span>
            <span>Á∑®Êàê</span>
        </button>
        <button class="nav-btn" onclick="showScreen('settings')">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span>Ë®≠ÂÆö</span>
        </button>
    </div>
</body>
</html>
