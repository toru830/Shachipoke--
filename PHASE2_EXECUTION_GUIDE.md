# Phase 2: データベース統合 - 残タスク完了手順書

## 🎯 概要
Phase 2の残タスクを完了し、本格的なデータベース統合を実現します。

## 📋 実行順序
以下の順序でSQLファイルをSupabase SQL Editorで実行してください。

### 1️⃣ **RLS状況確認** (`check-rls-status.sql`)
**目的**: 現在のRLS状況を確認
**実行方法**: 
1. Supabaseダッシュボード → SQL Editor
2. `check-rls-status.sql`の内容をコピー&ペースト
3. "Run"ボタンをクリック
**期待結果**: RLSが無効になっていることを確認

### 2️⃣ **RLSの再有効化** (`enable-rls-secure.sql`)
**目的**: セキュリティポリシーを修正してRLSを再有効化
**実行方法**:
1. `enable-rls-secure.sql`の内容をコピー&ペースト
2. "Run"ボタンをクリック
**期待結果**: RLSが有効になり、適切なポリシーが作成される

### 3️⃣ **RLSテスト** (`test-rls-policies.sql`)
**目的**: RLSが正しく動作するかテスト
**実行方法**:
1. 認証された状態で`test-rls-policies.sql`を実行
2. 自分のデータはアクセス可能、他人のデータはアクセス不可を確認
**期待結果**: セキュリティが正しく機能していることを確認

### 4️⃣ **クエリ最適化** (`optimize-queries.sql`)
**目的**: パフォーマンス向上のためのインデックス追加
**実行方法**:
1. `optimize-queries.sql`の内容をコピー&ペースト
2. "Run"ボタンをクリック
**期待結果**: 追加インデックスが作成され、クエリが高速化される

### 5️⃣ **データ整合性制約** (`data-integrity-constraints.sql`)
**目的**: データの整合性を保つための制約とバリデーション追加
**実行方法**:
1. `data-integrity-constraints.sql`の内容をコピー&ペースト
2. "Run"ボタンをクリック
**期待結果**: データ整合性制約が追加され、不正なデータの挿入を防止

### 6️⃣ **パフォーマンステスト** (`performance-test.sql`)
**目的**: データベースのパフォーマンスを測定
**実行方法**:
1. `performance-test.sql`の内容をコピー&ペースト
2. "Run"ボタンをクリック
**期待結果**: パフォーマンス指標が表示され、最適化が確認される

### 7️⃣ **セキュリティ監査** (`security-audit.sql`)
**目的**: セキュリティ設定の包括的チェック
**実行方法**:
1. `security-audit.sql`の内容をコピー&ペースト
2. "Run"ボタンをクリック
**期待結果**: セキュリティチェックリストが全て✅PASSになる

## ⚠️ 注意事項

### 実行前の確認
- [ ] Supabaseプロジェクトにログイン済み
- [ ] SQL Editorにアクセス可能
- [ ] 認証されたユーザーでテスト可能

### エラーが発生した場合
1. **制約エラー**: 既存データが制約に違反している可能性
2. **権限エラー**: 適切な権限がない可能性
3. **構文エラー**: SQLの構文に問題がある可能性

### ロールバック方法
問題が発生した場合は、以下のSQLでRLSを一時的に無効化：
```sql
ALTER TABLE profiles DISABLE ROW LEVEL SECURITY;
ALTER TABLE game_saves DISABLE ROW LEVEL SECURITY;
```

## 🎯 完了基準

### ✅ Phase 2-1: RLSの再有効化
- [ ] RLSが有効になっている
- [ ] 適切なポリシーが作成されている
- [ ] セキュリティテストが成功している

### ✅ Phase 2-2: 高度なクエリ最適化
- [ ] 追加インデックスが作成されている
- [ ] クエリパフォーマンスが向上している
- [ ] 統計情報が更新されている

### ✅ Phase 2-3: データ整合性の最終確認
- [ ] データ整合性制約が追加されている
- [ ] バリデーション関数が作成されている
- [ ] 既存データの整合性が確認されている

### ✅ Phase 2-4: パフォーマンステスト
- [ ] パフォーマンス指標が測定されている
- [ ] インデックス使用状況が確認されている
- [ ] 最適化が確認されている

### ✅ Phase 2-5: セキュリティ監査
- [ ] セキュリティチェックが完了している
- [ ] 全ての項目が✅PASSになっている
- [ ] セキュリティリスクが解消されている

## 🚀 完了後の確認

Phase 2完了後、以下を確認してください：

1. **ゲームの動作確認**: 認証・ログアウト・データ保存が正常に動作
2. **セキュリティ確認**: 他のユーザーのデータにアクセスできない
3. **パフォーマンス確認**: データの読み書きが高速
4. **データ整合性確認**: 不正なデータが保存されない

## 📞 サポート

問題が発生した場合は、エラーメッセージと実行したSQLファイル名を教えてください。
